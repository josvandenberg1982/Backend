<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Taakplanner</title>

<style>
 :root{
   --border:#ddd;
   --muted:#666;
   --bg:#fff;
   --soft:#fafafa;
   --soft2:#f6f7f8;
   --danger:#b00020;
   --warn:#b36b00;
   --ok:#0b7a3b;

   --radius:16px;
   --shadow: 0 1px 0 rgba(0,0,0,.03);
   --card-border:#e7e7e7;

   --nav-h:56px;

   --primary:#2563eb;
   --primary-hover:#1d4ed8;
   --primary-press:#1e40af;
   --week-title-size:16px;
 }

 * { box-sizing:border-box; }
 html, body { height:100%; }
 body {
   font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
   margin:0;
   background:var(--bg);
   color:#111;
   -webkit-text-size-adjust: 100%;
 }

nav {
  display:none;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  position: sticky;
  top:0;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 10;
  min-height: var(--nav-h);
  align-items:center;
  justify-content:space-between;
}

 section { padding:12px; max-width:1100px; margin:0 auto; }

 input, select, textarea, button {
   width:100%;
   margin:6px 0;
   font-size:16px;
 }

 button { cursor:pointer; }

 .small { font-size: 12px; color:var(--muted); }
 .muted { color:var(--muted); }

 .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
 .row > * { flex: 1 1 180px; }
 .settings-add-row { justify-content: center; }
 .settings-add-row > * { flex: 1 1 200px; }

 .date-row > div { flex: 1 1 160px; }

 @media (max-width: 520px){
   nav { gap:6px; padding:8px; flex-wrap:wrap; }
   nav .btn { padding:8px 10px; font-size:14px; flex:1 1 calc(50% - 6px); }
   .date-row > div { flex: 1 1 140px; }
 }

 hr { border:0; border-top:1px solid #eee; margin:12px 0; }

 .card {
   border:1px solid var(--card-border);
   background:#fff;
   border-radius: var(--radius);
   overflow:hidden;
   box-shadow: var(--shadow);
 }
 .card-pad { padding:12px; }
 .card-head {
   padding:10px 12px;
   background:#fff;
   border-bottom:1px solid var(--border);
   display:flex;
   justify-content:space-between;
   gap:10px;
   align-items:baseline;
 }
 .card-head strong { font-size:14px; }
 .card-body { padding:12px; background:var(--soft2); }

 .badge {
   display:inline-block;
   padding:2px 8px;
   border:1px solid #ccc;
   border-radius: 999px;
   font-size: 12px;
   background:#fff;
   line-height: 1.5;
 }
 .pill  {
   display:inline-flex;
   align-items:center;
   gap:6px;
   padding:3px 10px;
   border:1px solid #ccc;
   border-radius: 999px;
   font-size:12px;
   background:#fff;
   margin-right:6px;
   margin-top:6px;
   line-height: 1.4;
 }
 .week-task-meta .pill {
   font-size:11px;
   padding:2px 8px;
 }
 .dot {
   width:10px; height:10px;
   border-radius:999px;
   display:inline-block;
   border:1px solid rgba(0,0,0,.15);
   flex: 0 0 10px;
 }

 .note {
   white-space: pre-wrap;
   background:var(--soft);
   border:1px solid #eee;
   border-radius:14px;
   padding:10px;
   margin-top:8px;
   font-size: 13px;
 }

 .btn {
   border:1px solid #cfcfcf;
   background:#fff;
   border-radius: 14px;
   padding:10px 12px;
 }
 .btn:active { transform: translateY(0.5px); }

 .btn-primary {
   background: var(--primary);
   color: #fff;
   border-color: var(--primary);
   font-weight:700;
   min-height: 54px;
 }
 .btn-primary:hover{
   backgroundNS: var(--primary-hover);
   border-color: var(--primary-hover);
 }
 .btn-primary:active{
   background: var(--primary-press);
   border-color: var(--primary-press);
 }
 .btn-primary:focus{
   outline: 2px solid rgba(37,99,235,.35);
   outline-offset: 2px;
 }

 .btn-small {
   width:auto;
   padding:8px 10px;
   border-radius:12px;
 }
 nav .btn {
   width:auto;
   margin:0;
   padding:10px 12px;
   border-radius: 14px;
   min-height: 44px;
   white-space:nowrap;
   flex: 1 1 0;
   text-align:center;
 }
 nav .btn-primary { min-height: 48px; }

 .unplanned { border-left: 4px solid #c90; }
.done-row { opacity:.45; }
 .danger { color:var(--danger); border-color: rgba(176,0,32,.35); }
 .warn { color:var(--warn); border-color: rgba(179,107,0,.35); }
 .ok { color:var(--ok); border-color: rgba(11,122,59,.35); }

 .cl-wrap { border:1px solid #eee; border-radius:14px; padding:10px; background:#fff; }
 .cl-head { display:flex; justify-content: space-between; gap:10px; align-items:center; }
 .cl-head strong { font-size: 13px; }
 .cl-list { list-style:none; padding:0; margin:8px 0 0 0; }
 .cl-item { display:flex; gap:8px; align-items:center; padding:6px 0; border-top:1px dashed #eee; }
 .cl-item:first-child { border-top:0; }
 .cl-item input[type="checkbox"] { width:auto; }
 .cl-item .txt { flex:1; }
 .cl-item .done { text-decoration: line-through; color:#777; }

 .mini-row { display:flex; gap:8px; align-items:center; }
 .mini-row > input { flex:1; margin:0; }
 .mini-row > button { width:auto; margin:0; }

 .week-grid{
   display:grid;
   grid-template-columns: 1fr;
   gap:12px;
 }
 .week-grid.workweek{
   grid-template-columns: 1fr;
 }
 @media (min-width: 980px){
   .week-grid{
     grid-template-columns: repeat(7, 1fr);
     align-items: start;
   }
   .week-grid.workweek{
     grid-template-columns: repeat(5, 1fr);
     align-items: start;
   }
 }

 .week-day {
   border:1px solid var(--border);
   background:var(--soft2);
   border-radius: var(--radius);
   overflow:hidden;
   scroll-margin-top: calc(var(--nav-h) + 12px);
 }
 .week-day.today{
   border-color:#cfd8ff;
   box-shadow: 0 0 0 2px rgba(37,99,235,.08);
 }
 .week-day-head{
   padding:10px 12px;
   background:#fff;
   border-bottom:1px solid var(--border);
   display:flex;
   justify-content:space-between;
   gap:10px;
   align-items:baseline;
 }
 .week-day-head .week-day-name{ font-size:var(--week-title-size); font-weight:700; }
 .week-day-head .week-day-date{ font-size:12px; color:var(--muted); }
 .week-today-badge{
   display:inline-flex;
   align-items:center;
   padding:2px 8px;
   border-radius:999px;
   font-size:11px;
   font-weight:700;
   color:#0f172a;
   background:rgba(37,99,235,.12);
   border:1px solid rgba(37,99,235,.22);
   margin-left:6px;
 }
 .week-day-body{ padding:10px 10px 12px 10px; }
 .week-empty{
   padding:10px;
   border:1px dashed #ddd;
   border-radius:14px;
   background:#fff;
 }

 .week-task {
   background:#fff;
   border:1px solid #e7e7e7;
   border-radius:14px;
   padding:10px;
   margin-top:10px;
   box-shadow: var(--shadow);
 }
 .week-task:first-child{ margin-top:0; }

.week-task-title {
   font-weight: 750;
   font-size: var(--week-title-size);
   line-height: 1.25;
   margin: 0;
   word-break: normal;
   overflow-wrap: normal;
 }

 .week-task-meta{
   display:flex;
   flex-wrap:wrap;
   gap:6px;
   margin-top:2px;
 }
 .week-cl-summary{
   margin:6px 0 0 0;
   padding-left:0;
   list-style:none;
   font-size:12px;
   color:#444;
 }
 .week-cl-summary li{ margin:2px 0; display:flex; align-items:center; }
 .week-cl-summary .done{ text-decoration: line-through; color:#777; }
 .week-cl-summary input[type="checkbox"]{ width:auto; margin-right:6px; }
 details[open] .week-cl-summary{ display:none; }

 .week-cl { margin-top:10px; border-top:1px dashed #eee; padding-top:8px; }
 .week-cl ul { list-style:none; padding:0; margin:0; }
 .week-cl li {
   display:flex;
   gap:8px;
   align-items:flex-start;
   padding: 4px 0;
   font-size: 12px;
   color:#444;
 }
 .week-cl input[type="checkbox"]{ width:auto; margin-top:2px; }
 .week-cl .txt.done { text-decoration: line-through; color:#777; }

 .week-actions{
   display:flex;
   gap:8px;
   flex-wrap:wrap;
   margin-top:10px;
   border-top:1px solid #f1f1f1;
   padding-top:10px;
 }
 .week-actions button{
   flex: 1 1 120px;
   margin:0;
 }

 .week-task details > summary { cursor:pointer; list-style:none; }
 .week-task details > summary::-webkit-details-marker { display:none; }
 .week-summary-row { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
 .week-summary-row .small { margin-top:2px; }

 .pri-High{ border-left: 4px solid rgba(176,0,32,.55); }
 .pri-Medium{ border-left: 4px solid rgba(179,107,0,.55); }
 .pri-Low{ border-left: 4px solid rgba(11,122,59,.45); }

 .task-list { display:flex; flex-direction:column; gap:12px; }
 .group-block { margin-bottom:12px; }
 .group-head { display:flex; align-items:center; gap:8px; margin:4px 2px 8px; }
 .group-body { display:flex; flex-direction:column; gap:12px; }
.group-done { opacity: 0.75; }

 .week-group { margin-top:10px; }
 .week-group:first-child { margin-top:0; }
 .week-group-head { display:flex; align-items:center; gap:8px; margin:0 0 6px; }
 .week-group-body { display:flex; flex-direction:column; gap:10px; }

 .task-card { background:#fff; border:1px solid #e7e7e7; border-radius: var(--radius); overflow:hidden; box-shadow: var(--shadow); }
 .task-card.unplanned { background:#fff1f1; border-color:#f1caca; }
 .task-card.unplanned .task-card-top { background:#fff1f1; }
 .task-card-top { padding:12px; background:#fff; }
 .task-card-meta { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
 .task-card-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
 .task-card-actions button { flex:1 1 140px; margin:0; }
 .task-card-edit { padding:12px; background:var(--soft2); border-top:1px solid #eee; }
 details > summary { cursor:pointer; list-style:none; }
 details > summary::-webkit-details-marker { display:none; }
 .summary-row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
 .summary-row strong { font-size:16px; }

 label { display:block; margin-top:8px; font-size: 13px; color:#333; }

 .pull-refresh {
   position: fixed;
   top: 0;
   left: 0;
   right: 0;
   height: 36px;
   display: flex;
   align-items: center;
   justify-content: center;
   font-size: 12px;
   color: #444;
   background: #f7f7f7;
   border-bottom: 1px solid #eee;
   z-index: 20;
   transform: translateY(-40px);
   transition: transform 0.2s ease;
 }
 .pull-refresh.show { transform: translateY(0); }

 .toast{
   position: fixed;
   left: 50%;
   bottom: 16px;
   transform: translateX(-50%);
   background: #111;
   color: #fff;
   padding: 10px 14px;
   border-radius: 12px;
   font-size: 13px;
   box-shadow: 0 6px 18px rgba(0,0,0,.2);
   opacity: 0;
   transition: opacity 0.2s ease, transform 0.2s ease;
   pointer-events: none;
   z-index: 30;
 }
 .toast.show{
   opacity: 1;
   transform: translate(-50%,-4px);
 }

 /* PDF knoppen in Settings */
 .btn-inline {
   width: auto;
   display: inline-flex;
   align-items: center;
   gap: 8px;
   margin: 6px 6px 0 0;
   padding: 10px 12px;
   border-radius: 14px;
   border: 1px solid #cfcfcf;
   background: #fff;
   cursor: pointer;
   white-space: nowrap;
 }
 .btn-inline:active { transform: translateY(0.5px); }
 .btn-inline-primary {
   background: var(--primary);
   border-color: var(--primary);
   color: #fff;
   font-weight: 700;
 }

 #projectList,
 #labelList {
   list-style: none;
   padding: 0;
   margin: 0;
 }
#projectList li,
#labelList li {
  margin: 6px 0;
  list-style: none;
}
 #projectList .row,
 #labelList .row {
   gap: 8px;
 }
 #projectList .pill,
 #labelList .pill {
   font-size: 11px;
   padding: 2px 8px;
 }
.project-item {
  border: 1px solid #dcdcdc;
  border-radius: 12px;
  padding: 12px;
  background: #fafafa;
  box-shadow: 0 1px 0 rgba(0,0,0,.03);
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 8px;
}
.project-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  font-size: 15px;
  justify-content: center;
  width: 100%;
  text-align: center;
}
.project-title .project-name {
  font-weight: 800;
  font-size: 15px;
}
.project-divider {
  height: 1px;
  background: #e7e7e7;
  margin: 4px 0;
  width: 100%;
}
.project-controls .btn {
  width: auto;
}
.project-controls {
  justify-content: center;
}
.project-inner {
  border: 1px solid #ececec;
  border-radius: 10px;
  padding: 8px;
  background: #fff;
  width: 100%;
  align-self: stretch;
  box-sizing: border-box;
}
 .project-actions {
   display: flex;
   flex-wrap: wrap;
   gap: 8px;
   margin-top: 6px;
   justify-content: center;
 }
.project-actions .btn-inline {
   margin: 0;
 }
.project-note {
  margin-top: 6px;
  text-align: center;
}
.color-compact {
   width: 28px;
   height: 28px;
   padding: 0;
   border-radius: 8px;
   border: 1px solid #cfcfcf;
   background: #fff;
   -webkit-appearance: none;
   appearance: none;
 }
 input.color-compact::-webkit-color-swatch-wrapper { padding: 0; }
 input.color-compact::-webkit-color-swatch { border: 0; border-radius: 6px; }
 input.color-compact::-moz-color-swatch { border: 0; border-radius: 6px; }
 input.color-compact::-moz-focus-inner { border: 0; padding: 0; }

 /* ============================================================
    NAV TABS: standaard primary, actieve tab rood + streepje
    ============================================================ */

 /* standaard: alle nav tabs primary (blauw) */
 nav .btn{
   background: var(--primary);
   border-color: var(--primary);
   color: #fff;
   font-weight: 800;
   position: relative; /* nodig voor ::after streepje */
 }

 nav .btn:hover{
   background: var(--primary-hover);
   border-color: var(--primary-hover);
 }

 nav .btn:active{
   background: var(--primary-press);
   border-color: var(--primary-press);
 }

 /* actieve tab: rood */
 nav .btn.is-active{
   background:#d10000;
   border-color:#d10000;
 }

 nav .btn.is-active:hover{
   background:#b40000;
   border-color:#b40000;
 }

 nav .btn.is-active:active{
   background:#920000;
   border-color:#920000;
 }

 /* streepje onder actieve tab */
 nav .btn.is-active::after{
   content:"";
   position:absolute;
   left:10px;
   right:10px;
   bottom:6px;
   height:3px;
   border-radius:999px;
   background: rgba(255,255,255,.95); /* wit streepje */
 }
</style>
</head>

<body>

<div id="pullRefresh" class="pull-refresh" hidden>Vernieuwen...</div>
<div id="toast" class="toast" hidden></div>

<nav>
  <button class="btn" type="button" data-tab="create" onclick="show('create')">Nieuwe taak</button>
  <button class="btn" type="button" data-tab="tasks" onclick="show('tasks')">Takenlijst</button>
  <button class="btn" type="button" data-tab="week" onclick="show('week')">Week</button>
  <button class="btn" type="button" data-tab="settings" onclick="show('settings')">Settings</button>
</nav>

<section id="authGate" style="padding:12px; max-width:520px; margin:0 auto;">
 <div class="card">
   <div class="card-head"><strong>Inloggen</strong></div>
   <div class="card-pad">
     <label>E-mail</label>
     <input id="authEmail" type="email" placeholder="jij@domein.nl" autocomplete="email">

     <label>Wachtwoord</label>
     <input id="authPass" type="password" placeholder="••••••••" autocomplete="current-password">

     <div class="row" style="margin-top:6px;">
       <button class="btn btn-primary" type="button" id="btnLogin">Login</button>
       <button class="btn" type="button" id="btnSignup">Account maken</button>
     </div>

     <button class="btn" type="button" id="btnLogout" hidden>Logout</button>

     <div id="authStatus" class="small muted" style="margin-top:8px;"></div>
     <hr>
     <div class="small muted">
       Tip: Als je later via GitHub Pages opent, moet je in Firebase bij Authentication → Authorized domains ook
       jouw <code>&lt;username&gt;.github.io</code> toevoegen.
     </div>
   </div>
 </div>
</section>

<section id="create" hidden>
 <div class="card">
   <div class="card-head"><strong>Nieuwe taak</strong></div>
   <div class="card-pad">
     <form onsubmit="addTask(event)">
       <label>Taakomschrijving</label>
       <input id="title" required placeholder="Bijv. offerte maken, engineering, administratie">

       <div class="row date-row">
         <div>
           <label>Project</label>
           <select id="createProject"></select>
         </div>
         <div>
           <label>Prioriteit</label>
           <select id="createPriority">
             <option>High</option>
             <option selected>Medium</option>
             <option>Low</option>
           </select>
         </div>
         <div>
           <label>Schatting (uren)</label>
           <input id="createEstimate" type="number" min="0" step="0.5" value="1">
         </div>
       </div>

       <div class="row">
         <div>
           <label>Datum inplannen</label>
           <input id="createPlanned" type="date">
         </div>
         <div>
           <label>Einddatum planning</label>
           <input id="createPlannedEnd" type="date">
         </div>
         <div>
           <label>Deadline</label>
           <input id="createDeadline" type="date">
         </div>
       </div>

       <label>Labels (komma-gescheiden)</label>
       <input id="createTags" placeholder="bijv. klant, urgent, inkoop">

       <button class="btn btn-primary" type="submit">Taak toevoegen</button>
     </form>
     <div class="small">Na opslaan ga je automatisch naar de takenlijst.</div>
   </div>
 </div>
</section>

<section id="tasks" hidden>
 <h2>Overall takenlijst</h2>

 <div class="card" style="margin-bottom:12px;">
   <div class="card-head">
     <strong>Filters</strong>
     <span class="small muted">Niet ingepland en nieuwste staan bovenaan.</span>
   </div>
   <div class="card-pad">
     <div class="row settings-add-row">
       <div>
         <label>Zoeken</label>
         <input id="q" placeholder="Zoek in titel/tags/opmerkingen" oninput="renderTasks()">
       </div>
       <div>
         <label>Project</label>
         <select id="fProject" onchange="renderTasks()"></select>
       </div>
       <div>
         <label>Status</label>
         <select id="fStatus" onchange="renderTasks()">
           <option value="">Alle</option>
           <option>Todo</option>
           <option>Planned</option>
           <option>Done</option>
           <option value="Archived">Archived</option>
         </select>
       </div>
       <div>
         <label>Toon Done</label>
         <select id="showDone" onchange="renderTasks()">
           <option value="yes" selected>Ja</option>
           <option value="no">Nee</option>
         </select>
       </div>
     </div>
     <div class="small muted">
       Deadline krijgt een badge (overdue / binnenkort). Bewerken zit per taak in een uitklapblok.
     </div>
   </div>
 </div>

 <div id="taskList" class="task-list"></div>
</section>

<section id="week" hidden>
 <h2 id="weekTitle"></h2>

 <div class="row">
   <button class="btn" type="button" onclick="changeWeek(-1)">← Vorige</button>
   <button class="btn" type="button" onclick="goThisWeek()">Deze week</button>
   <button class="btn" type="button" onclick="changeWeek(1)">Volgende →</button>
 </div>

 <div class="small" style="margin-top:8px;">
   In weekoverzicht kun je checklist-items aanvinken en taken afronden/archiveren.
 </div>

 <div id="weekGrid" class="week-grid" style="margin-top:12px;"></div>
</section>

<section id="settings" hidden>
 <h2>Settings</h2>

 <div class="card">
   <div class="card-head"><strong>Totale planning</strong></div>
   <div class="card-pad">
     <button class="btn-inline btn-inline-primary" type="button"
             onclick="generateTotalPDF({ includeGantt:true })">
       Totale planning PDF + Gantt
     </button>
     <button class="btn-inline" type="button"
             onclick="generateTotalPDF({ includeGantt:false })">
       Totale planning PDF
     </button>
   </div>
 </div>

 <div style="height:12px;"></div>

 <div class="card">
   <div class="card-head"><strong>Weekweergave</strong></div>
   <div class="card-pad">
     <label>Toon dagen</label>
     <select id="weekMode" onchange="setWeekMode(this.value)">
       <option value="full">Volledige week (ma-zo)</option>
       <option value="workweek">Werkweek (ma-vr)</option>
     </select>
     <div class="small muted">Werkweek verbergt zaterdag en zondag in het weekoverzicht.</div>
   </div>
 </div>

 <div style="height:12px;"></div>

 <div class="card">
   <div class="card-head"><strong>Projecten</strong></div>
   <div class="card-pad">
     <div class="row settings-add-row">
       <input id="newProject" placeholder="Nieuw project (naam)">
      <input id="newProjectColor" class="color-compact" type="color" value="#4a90e2" title="Kleur">
       <button class="btn btn-primary" type="button" onclick="addProject()">Project toevoegen</button>
     </div>
     <div class="small muted">Projecten hebben een kleur (pills in taken/week).</div>
     <ul id="projectList"></ul>
   </div>
 </div>

 <div style="height:12px;"></div>

 <div class="card">
   <div class="card-head"><strong>Labels</strong></div>
   <div class="card-pad">
     <div class="row">
       <input id="newLabel" placeholder="Nieuw label (naam)">
      <input id="newLabelColor" class="color-compact" type="color" value="#7b7b7b" title="Kleur">
       <button class="btn btn-primary" type="button" onclick="addLabel()">Label toevoegen</button>
     </div>
     <div class="small muted">Labels komen uit het Tags-veld (komma-gescheiden). Geef ze hier een vaste kleur.</div>
     <ul id="labelList"></ul>
   </div>
 </div>

 <div style="height:12px;"></div>

 <div class="card">
   <div class="card-head"><strong>Notificatie (later met backend)</strong></div>
   <div class="card-pad">
     <div class="small muted">
       E-mail en tijdstip slaan we alvast op, maar automatische e-mail vereist een backend.
     </div>

     <label>E-mail adres</label>
     <input id="emailTo" placeholder="jij@domein.nl">

     <div class="row">
       <div>
         <label>Uur</label>
         <input id="notifyHour" type="number" min="0" max="23">
       </div>
       <div>
         <label>Minuut</label>
         <input id="notifyMinute" type="number" min="0" max="59">
       </div>
     </div>

     <button class="btn btn-primary" type="button" onclick="saveSettings()">Settings opslaan</button>
   </div>
 </div>

 <div style="height:12px;"></div>

 <div class="card">
   <div class="card-head"><strong>Back-up</strong></div>
   <div class="card-pad">
     <div class="row">
       <button class="btn btn-primary" type="button" onclick="exportCSV()">Export CSV</button>
       <input id="importFile" type="file" accept=".csv,text/csv" onchange="importCSV(event)">
     </div>
     <div class="small muted">
       Export/Import via CSV (in plaats van JSON). Import vervangt je huidige data in deze browser.
     </div>
   </div>
 </div>

 <div style="height:12px;"></div>

 <div class="card">
   <div class="card-head"><strong>Reset</strong></div>
   <div class="card-pad">
     <button class="btn danger" type="button" onclick="resetAll()">Alles wissen (reset)</button>
     <div class="small muted">Let op: dit verwijdert alle taken en settings in je browser.</div>
   </div>
 </div>
</section>

<script>
const KEY = "taskplanner_v8_csv";

/** --------------------------
*  Date helpers (robust local)
*  -------------------------- **/
function pad2(n){ return String(n).padStart(2,"0"); }
function ymdFromDate(d){
 const x = new Date(d);
 return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
}
function dateFromYMD(ymd){
 const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(ymd||""));
 if (!m) return null;
 const y = Number(m[1]), mo = Number(m[2]), da = Number(m[3]);
 const dt = new Date(y, mo-1, da);
 if (dt.getFullYear()!==y || dt.getMonth()!==mo-1 || dt.getDate()!==da) return null;
 dt.setHours(0,0,0,0);
 return dt;
}
function startOfWeek(d){
 const x = new Date(d);
 x.setHours(0,0,0,0);
 const day = (x.getDay() + 6) % 7;
 x.setDate(x.getDate() - day);
 return x;
}
function parseWeek(value){
 if (!value) return startOfWeek(new Date());
 const dt = new Date(value);
 if (isNaN(dt.getTime())) return startOfWeek(new Date());
 return startOfWeek(dt);
}
function clampInt(v, fallback){
 const n = Number(v);
 return Number.isFinite(n) ? n : fallback;
}
function uid(){
 return (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + Date.now());
}

/** --- State --- **/
let state = load();
window.state = state;
const openTaskIds = new Set();

function setState(next){
 state = next;
 window.state = next;
}

function defaultState(){
 return {
   tasks: [],
   week: startOfWeek(new Date()).toISOString(),
   projects: [{ name:"Algemeen", color:"#4a90e2" }],
   labels: [],
   settings: { emailTo:"", notifyHour:12, notifyMinute:0, weekMode:"full" }
 };
}

function normalizeProjects(projects){
 const out = [];
 for (const p of (projects || [])){
   if (typeof p === "string"){
     out.push({ name:p, color:"#4a90e2" });
   } else if (p && typeof p === "object"){
     const name = String(p.name ?? "").trim();
     if (!name) continue;
     out.push({ name, color: String(p.color || "#4a90e2") });
   }
 }
 return out.length ? out : [{ name:"Algemeen", color:"#4a90e2" }];
}
function normalizeLabels(labels){
 const out = [];
 for (const l of (labels || [])){
   if (typeof l === "string"){
     out.push({ name:l, color:"#7b7b7b" });
   } else if (l && typeof l === "object"){
     const name = String(l.name ?? "").trim();
     if (!name) continue;
     out.push({ name, color: String(l.color || "#7b7b7b") });
   }
 }
 const seen = new Set();
 const ded = [];
 for (const l of out){
   const k = l.name.toLowerCase();
   if (seen.has(k)) continue;
   seen.add(k);
   ded.push(l);
 }
 return ded;
}

function migrateTask(t){
 if (!("project" in t)) t.project = getProjectNames()[0] || "Algemeen";
 if (!("priority" in t)) t.priority = "Medium";
 if (!("status" in t)) t.status = "Todo";
 if (!("estimateHours" in t)) t.estimateHours = 1;
 if (!("deadline" in t)) t.deadline = "";
 if (!("tags" in t)) t.tags = "";
 if (!("notes" in t)) t.notes = "";
 if (!("planned" in t)) t.planned = "";
 if (!("plannedEnd" in t)) t.plannedEnd = "";
 if (!("created" in t)) t.created = Date.now();
 if (!("updated" in t)) t.updated = t.created;
 if (!Array.isArray(t.checklist)) t.checklist = [];
 for (const it of t.checklist) {
   if (!it.id) it.id = uid();
   if (typeof it.text !== "string") it.text = String(it.text ?? "");
   it.done = !!it.done;
 }
 if (t.status !== "Todo" && t.status !== "Planned" && t.status !== "Done" && t.status !== "Archived"){
   t.status = "Todo";
 }
 if ("slot" in t) delete t.slot;
 return t;
}

function load(){
 const raw = localStorage.getItem(KEY);
 if (!raw) {
   const legacyKeys = ["taskplanner_v7","taskplanner_v6","taskplanner_v5"];
   for (const k of legacyKeys){
     const legacy = localStorage.getItem(k);
     if (legacy){
       try{
         JSON.parse(legacy);
         localStorage.setItem(KEY, legacy);
         break;
       }catch{}
     }
   }
 }

 const raw2 = localStorage.getItem(KEY);
 if (!raw2) return defaultState();

 try {
   const s = JSON.parse(raw2);

   if (!Array.isArray(s.tasks)) s.tasks = [];
   if (!s.week) s.week = startOfWeek(new Date()).toISOString();

   s.projects = normalizeProjects(s.projects);
   s.labels = normalizeLabels(s.labels);

  if (!s.settings) s.settings = { emailTo:"", notifyHour:12, notifyMinute:0, weekMode:"full" };
  s.settings.notifyHour = clampInt(s.settings.notifyHour, 12);
  s.settings.notifyMinute = clampInt(s.settings.notifyMinute, 0);
  s.settings.emailTo = String(s.settings.emailTo ?? "");
  s.settings.weekMode = (s.settings.weekMode === "workweek") ? "workweek" : "full";

   state = s;
   s.tasks = s.tasks.map(migrateTask);
   return s;
 } catch {
   return defaultState();
 }
}

function save(){
 localStorage.setItem(KEY, JSON.stringify(state));
 if (window.__cloud && window.__cloud.currentUid && typeof window.__cloud.saveStateToCloud === "function"){
   window.__cloud.saveStateToCloud(window.__cloud.currentUid, state).catch(console.error);
 }
}

function weekDate(){ return parseWeek(state.week); }
function setWeek(d){
 const next = startOfWeek(d);
 state.week = next.toISOString();
 save();
}

function rollOverTasks(prevWeekStart, newWeekStart){
 const newStartMs = newWeekStart.getTime();
 const isWorkweek = (state.settings && state.settings.weekMode === "workweek");
 let changed = false;
 for (const t of (state.tasks || [])){
  if (t.status === "Done" || t.status === "Archived") continue;
  const planned = dateFromYMD(t.planned);
  if (!planned) continue;

   const endRaw = dateFromYMD(t.plannedEnd || t.planned);
   let startMs = planned.getTime();
   let endMs = (endRaw || planned).getTime();
   if (endMs < startMs){
     const tmp = startMs; startMs = endMs; endMs = tmp;
   }

   if (isWorkweek){
     const startDate = new Date(startMs);
     const day = startDate.getDay();
     if (day === 0 || day === 6){
       const deltaDays = (day === 0) ? 1 : 2;
       startDate.setDate(startDate.getDate() + deltaDays);
       const endDate = new Date(endMs);
       endDate.setDate(endDate.getDate() + deltaDays);
       startMs = startDate.getTime();
       endMs = endDate.getTime();
       t.planned = ymdFromDate(startDate);
       if (t.plannedEnd){
         t.plannedEnd = ymdFromDate(endDate);
       } else {
         const durationDays = Math.round((endMs - startMs) / 86400000);
       t.plannedEnd = durationDays > 0 ? ymdFromDate(endDate) : "";
      }
      t.updated = Date.now();
      changed = true;
     }
   }

   if (endMs >= newStartMs) continue;

   const durationDays = Math.round((endMs - startMs) / 86400000);
   const newStart = new Date(newWeekStart);
   const newEnd = new Date(newWeekStart);
   newEnd.setDate(newEnd.getDate() + durationDays);

   t.planned = ymdFromDate(newStart);
   if (t.plannedEnd){
     t.plannedEnd = ymdFromDate(newEnd);
   } else {
     t.plannedEnd = durationDays > 0 ? ymdFromDate(newEnd) : "";
   }
   t.updated = Date.now();
   changed = true;
 }
 return changed;
}

function autoRollOverByToday(){
 const todayStart = startOfWeek(new Date());
 if (rollOverTasks(todayStart, todayStart)) save();
}

let detailsObserver = null;

function collapseAllDetails(){
 openTaskIds.clear();
 document.querySelectorAll("details[open]").forEach(d => { d.open = false; });
}

function observeDetails(){
 if (!("IntersectionObserver" in window)) return;
 if (!detailsObserver){
   detailsObserver = new IntersectionObserver((entries) => {
     for (const entry of entries){
       if (entry.isIntersecting) continue;
       const el = entry.target;
       if (el.open){
         el.open = false;
         const id = el.dataset.taskid;
         if (id) openTaskIds.delete(id);
       }
     }
   });
 }
 detailsObserver.disconnect();
 document.querySelectorAll("details[data-close-on-hide=\"1\"]").forEach(el => {
   detailsObserver.observe(el);
 });
}

function focusTodayInWeek(){
 const today = new Date();
 const weekStart = weekDate();
 if (startOfWeek(today).getTime() !== weekStart.getTime()) return;
 const id = "daywrap_" + ymdFromDate(today);
 const el = document.getElementById(id);
 if (!el) return;
 requestAnimationFrame(() => {
  el.scrollIntoView({ block:"start", inline:"center", behavior:"smooth" });
  const nav = document.querySelector("nav");
  const navH = nav ? nav.offsetHeight : 0;
  if (navH) window.scrollBy({ top: -navH - 12, left: 0, behavior: "smooth" });
 });
}

function refreshData(){
 const next = load();
 setState(next);
 renderCreate();
 rerenderVisible();
 if (!document.getElementById("settings").hidden) renderSettings();
}

function initPullToRefresh(){
 const el = document.getElementById("pullRefresh");
 if (!el) return;
 const scrollEl = document.scrollingElement || document.documentElement;
 let startY = 0;
 let pullDist = 0;
 let pulling = false;

 window.addEventListener("touchstart", (e) => {
   if (scrollEl.scrollTop > 0) return;
   startY = e.touches[0].clientY;
   pullDist = 0;
   pulling = true;
 }, { passive: true });

 window.addEventListener("touchmove", (e) => {
   if (!pulling) return;
   pullDist = e.touches[0].clientY - startY;
   if (pullDist <= 10) return;
   el.hidden = false;
   el.classList.add("show");
   el.textContent = pullDist > 60 ? "Loslaten om te vernieuwen" : "Vernieuwen...";
 }, { passive: true });

 window.addEventListener("touchend", () => {
   if (!pulling) return;
   if (pullDist > 60){
     el.textContent = "Vernieuwd";
     refreshData();
   }
   setTimeout(() => {
     el.classList.remove("show");
     el.hidden = true;
   }, 400);
   pulling = false;
   pullDist = 0;
 }, { passive: true });
}

/** --- Navigation --- **/
function setActiveTab(id){
 document.querySelectorAll("nav button[data-tab]").forEach(btn => {
   const active = btn.dataset.tab === id;
   btn.classList.toggle("is-active", active);
   btn.setAttribute("aria-current", active ? "page" : "false");
 });
}

function show(id){
 collapseAllDetails();
 document.querySelectorAll("section").forEach(s=>s.hidden=true);
 const el = document.getElementById(id);
 if (el) el.hidden=false;

 // ✅ active tab rood + underline
 setActiveTab(id);

 if (id === "tasks") renderTasks();
 if (id === "week") { setWeek(new Date()); renderWeek(); }
 if (id === "settings") renderSettings();
 if (id === "create") renderCreate();
}

/** --- Projects & labels lookups --- **/
function getProjectNames(){ return (state.projects||[]).map(p => p.name); }
function getProjectColor(name){
 const p = (state.projects||[]).find(x => x.name === name);
 return p ? (p.color || "#4a90e2") : "#4a90e2";
}
function getLabelColor(name){
 const l = (state.labels||[]).find(x => x.name.toLowerCase() === String(name||"").toLowerCase());
 return l ? (l.color || "#7b7b7b") : "#7b7b7b";
}
function splitTags(s){
 return String(s||"")
   .split(",")
   .map(x => x.trim())
   .filter(Boolean);
}

/** --- Create form --- **/
function renderCreate(){
 const sel = document.getElementById("createProject");
 if (!sel) return;
 const names = getProjectNames();
 sel.innerHTML = names.map(p => `<option>${escapeHtml(p)}</option>`).join("");
}

/** --- Task creation --- **/
function addTask(e){
 e.preventDefault();

 const planned = (createPlanned.value || "");
  const status = planned ? "Planned" : "Todo";

  const t = {
    id: uid(),
    title: title.value.trim(),
   created: Date.now(),
   updated: Date.now(),
   project: createProject.value || (getProjectNames()[0] || "Algemeen"),
   priority: createPriority.value || "Medium",
   status,
   estimateHours: Number(createEstimate.value || 1),
    planned,
    plannedEnd: createPlannedEnd.value || "",
    deadline: createDeadline.value || "",
   tags: (createTags.value || "").trim(),
   notes: "",
   checklist: []
 };

 state.tasks.push(t);
 save();

 title.value = "";
 createPriority.value = "Medium";
 createEstimate.value = 1;
 createPlanned.value = "";
 createPlannedEnd.value = "";
 createDeadline.value = "";
 createTags.value = "";

 show("tasks");
}

/** --- Sorting --- **/
function sortTasks(list){
 return [...list].sort((a,b) => {
   const aArch = a.status === "Archived";
   const bArch = b.status === "Archived";
   if (aArch !== bArch) return aArch ? 1 : -1;

   const aPlanned = !!a.planned;
   const bPlanned = !!b.planned;
   if (aPlanned !== bPlanned) return aPlanned ? 1 : -1;

   if (!aPlanned && !bPlanned) return (b.created||0) - (a.created||0);

   const d = String(a.planned).localeCompare(String(b.planned));
   if (d !== 0) return d;

   return (b.created||0) - (a.created||0);
 });
}

/** --- Update fields --- **/
function updateTaskField(id, field, value){
 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;
 const prevPlanned = t.planned;
 t[field] = value;
 t.updated = Date.now();

 if (field === "planned"){
   setPlannedDate(t, t.planned, prevPlanned);
   if (t.planned && t.status === "Todo") t.status = "Planned";
   if (!t.planned && t.status === "Planned") t.status = "Todo";
   bumpWeekendPlanned(t);
   if (normalizePlannedRange(t)) showToast("Einddatum is aangepast naar dezelfde dag als startdatum.");
 }

 if (field === "plannedEnd"){
   if (t.plannedEnd && !t.planned) t.planned = t.plannedEnd;
   if (normalizePlannedRange(t)) showToast("Einddatum is aangepast naar dezelfde dag als startdatum.");
   if (t.planned && t.status === "Todo") t.status = "Planned";
   if (!t.planned && t.status === "Planned") t.status = "Todo";
 }

 if (field === "estimateHours"){
   t.estimateHours = (value === "" || value === null || value === undefined) ? "" : Number(value);
 }

 save();
 rerenderVisible();
}

function rerenderVisible(){
 if (!document.getElementById("tasks").hidden) renderTasks();
 if (!document.getElementById("week").hidden) renderWeek();
}

function bumpWeekendPlanned(t){
 if (!t || !t.planned) return false;
 if (!(state.settings && state.settings.weekMode === "workweek")) return false;
 const startDate = dateFromYMD(t.planned);
 if (!startDate) return false;
 const day = startDate.getDay();
 if (day !== 0 && day !== 6) return false;

 const endDate = dateFromYMD(t.plannedEnd || t.planned) || new Date(startDate);
 const durationDays = Math.round((endDate - startDate) / 86400000);
 const deltaDays = (day === 0) ? 1 : 2;
 startDate.setDate(startDate.getDate() + deltaDays);
 endDate.setDate(endDate.getDate() + deltaDays);

 t.planned = ymdFromDate(startDate);
 if (t.plannedEnd){
   t.plannedEnd = ymdFromDate(endDate);
 } else {
   t.plannedEnd = durationDays > 0 ? ymdFromDate(endDate) : "";
 }
 t.updated = Date.now();
 return true;
}

function shiftPlannedEnd(t, prevPlanned, nextPlanned){
 const prev = dateFromYMD(prevPlanned);
 const next = dateFromYMD(nextPlanned);
 const end = dateFromYMD(t && t.plannedEnd);
 if (!prev || !next || !end) return;
 const deltaDays = Math.round((next - prev) / 86400000);
 if (!deltaDays) return;
 const newEnd = new Date(end);
 newEnd.setDate(newEnd.getDate() + deltaDays);
 t.plannedEnd = ymdFromDate(newEnd);
}
function setPlannedDate(t, nextPlanned, prevPlanned){
 if (!t) return;
 const prev = (prevPlanned !== undefined) ? prevPlanned : t.planned;
 if (prev === nextPlanned) return;
 t.planned = nextPlanned;
 if (!nextPlanned) t.plannedEnd = "";
}

function taskSpansDate(t, ymd){
 const d = dateFromYMD(ymd);
 if (!d) return false;
 const s = dateFromYMD(t.planned);
 if (!s) return false;
 const eRaw = dateFromYMD(t.plannedEnd || t.planned);
 const e = eRaw || s;
 const sTime = s.getTime();
 const eTime = e.getTime();
 const min = Math.min(sTime, eTime);
 const max = Math.max(sTime, eTime);
 const dt = d.getTime();
 return dt >= min && dt <= max;
}

/** --- Planning date (commit-on-blur) --- **/
function rememberDate(el){ el.dataset.prev = el.value || ""; }
function commitDate(el){
 const id = el.dataset.taskid;
 const next = el.value || "";

 const t = state.tasks.find(x => x.id === id);
 if (!t) return;

 if (t.planned === next) return;
 setPlannedDate(t, next);

 if (next) {
   if (t.status === "Todo") t.status = "Planned";
 } else {
   if (t.status === "Planned") t.status = "Todo";
 }

 bumpWeekendPlanned(t);
 if (normalizePlannedRange(t)) showToast("Einddatum is aangepast naar dezelfde dag als startdatum.");

 t.updated = Date.now();
 save();
 rerenderVisible();
}

function planToday(id){
 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;
 setPlannedDate(t, ymdFromDate(new Date()));
 if (normalizePlannedRange(t)) showToast("Einddatum is aangepast naar dezelfde dag als startdatum.");
 if (t.status === "Todo") t.status = "Planned";
 t.updated = Date.now();
 save();
 rerenderVisible();
}
function clearPlan(id){
 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;
 setPlannedDate(t, "");
 normalizePlannedRange(t);
 if (t.status === "Planned") t.status = "Todo";
 t.updated = Date.now();
 save();
 rerenderVisible();
}

function normalizePlannedRange(t){
 if (!t || !t.planned || !t.plannedEnd) return false;
 const start = dateFromYMD(t.planned);
 const end = dateFromYMD(t.plannedEnd);
 if (!start || !end) return false;
 if (end < start){
   t.plannedEnd = t.planned;
   return true;
 }
 return false;
}

let toastTimer = null;
function showToast(msg){
 const el = document.getElementById("toast");
 if (!el) return;
 el.textContent = msg;
 el.hidden = false;
 requestAnimationFrame(() => el.classList.add("show"));
 if (toastTimer) clearTimeout(toastTimer);
 toastTimer = setTimeout(() => {
   el.classList.remove("show");
   setTimeout(() => { el.hidden = true; }, 200);
 }, 2200);
}

/** --- Delete / Archive / Done actions --- **/
function deleteTask(id){
 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;
 if (!confirm(`Taak verwijderen?\n\n${t.title}`)) return;
 state.tasks = state.tasks.filter(x=>x.id!==id);
 save();
 rerenderVisible();
}
function archiveTask(id){
 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;
 t.status = "Archived";
 t.updated = Date.now();
 save();
 rerenderVisible();
}
function markDone(id){
 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;
 t.status = "Done";
 t.updated = Date.now();
 save();
 rerenderVisible();
}

/** --- Checklist --- **/
function addChecklistItem(id){
 const input = document.getElementById("cl_new_" + id);
 if (!input) return;
 const txt = (input.value || "").trim();
 if (!txt) return;

 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;

 t.checklist.push({ id: uid(), text: txt, done: false });
 t.updated = Date.now();
 save();

 input.value = "";
 rerenderVisible();
}
function toggleChecklistItem(taskId, itemId, checked){
 const t = state.tasks.find(x=>x.id===taskId);
 if (!t) return;
 const it = t.checklist.find(i=>i.id===itemId);
 if (!it) return;

 it.done = !!checked;
 t.updated = Date.now();
 save();
 rerenderVisible();
}
function deleteChecklistItem(taskId, itemId){
 const t = state.tasks.find(x=>x.id===taskId);
 if (!t) return;

 t.checklist = t.checklist.filter(i=>i.id!==itemId);
 t.updated = Date.now();
 save();
 rerenderVisible();
}
function updateChecklistText(taskId, itemId, nextText){
 const t = state.tasks.find(x=>x.id===taskId);
 if (!t) return;
 const it = t.checklist.find(i=>i.id===itemId);
 if (!it) return;
 it.text = String(nextText || "").trim();
 t.updated = Date.now();
 save();
 rerenderVisible();
}
function moveChecklistItem(taskId, itemId, dir){
 const t = state.tasks.find(x=>x.id===taskId);
 if (!t) return;
 const idx = t.checklist.findIndex(i=>i.id===itemId);
 if (idx < 0) return;
 const next = idx + dir;
 if (next < 0 || next >= t.checklist.length) return;
 const [it] = t.checklist.splice(idx, 1);
 t.checklist.splice(next, 0, it);
 t.updated = Date.now();
 save();
 rerenderVisible();
}
function checklistForRender(t){
 const list = Array.isArray(t?.checklist) ? t.checklist.slice() : [];
 return list.sort((a,b) => Number(!!a.done) - Number(!!b.done));
}
function enableChecklistEdit(e, taskId, itemId, el){
 e.stopPropagation();
 e.preventDefault();

 if (!el || el.dataset.editing === "1") return;
 const t = state.tasks.find(x=>x.id===taskId);
 if (!t) return;
 const it = t.checklist.find(x=>x.id===itemId);
 if (!it) return;

 el.dataset.editing = "1";
 el.contentEditable = "true";
 el.focus();

 const sel = window.getSelection();
 if (sel){
   const range = document.createRange();
   range.selectNodeContents(el);
   sel.removeAllRanges();
   sel.addRange(range);
 }

 function finish(saveIt){
   if (saveIt){
     const next = (el.textContent || "").trim();
     if (next) updateChecklistText(taskId, itemId, next);
     else el.textContent = it.text;
   } else {
     el.textContent = it.text;
   }
   el.contentEditable = "false";
   delete el.dataset.editing;
 }

 el.onkeydown = (ev) => {
   if (ev.key === "Enter"){
     ev.preventDefault();
     finish(true);
   } else if (ev.key === "Escape"){
     ev.preventDefault();
     finish(false);
   }
 };
 el.onblur = () => finish(true);
}
function checklistProgress(t){
 const total = (t.checklist || []).length;
 const done = (t.checklist || []).filter(i=>i.done).length;
 return { total, done };
}

/** --- Deadline badge --- **/
function deadlineBadge(t){
 if (!t.deadline) return "";
 const dl = dateFromYMD(t.deadline);
 if (!dl) return `<span class="badge warn">Deadline ${escapeHtml(t.deadline)}</span>`;

 const today = dateFromYMD(ymdFromDate(new Date()));
 const ms = dl.getTime() - today.getTime();
 const days = Math.round(ms / 86400000);

 if (t.status !== "Done" && t.status !== "Archived" && days < 0){
   return `<span class="badge danger">Overdue ${escapeHtml(t.deadline)}</span>`;
 }
 if (t.status !== "Done" && t.status !== "Archived" && days <= 3){
   return `<span class="badge warn">Binnenkort ${escapeHtml(t.deadline)}</span>`;
 }
 return `<span class="badge">Deadline ${escapeHtml(t.deadline)}</span>`;
}

/** --- Filters --- **/
function buildFilters(){
 const fProject = document.getElementById("fProject");
 const cur = fProject.value || "";
 const names = getProjectNames();
 const options = ['<option value="">Alle</option>']
   .concat(names.map(p => `<option ${p===cur?'selected':''}>${escapeHtml(p)}</option>`));
 fProject.innerHTML = options.join("");
}

/** --- Render tasks --- **/
function toggleTaskOpen(id, isOpen){
 if (isOpen) openTaskIds.add(id);
 else openTaskIds.delete(id);
}

function enableTitleEdit(e, id, el){
 e.stopPropagation();
 e.preventDefault();

 if (!el || el.dataset.editing === "1") return;
 const t = state.tasks.find(x=>x.id===id);
 if (!t) return;

 el.dataset.editing = "1";
 el.contentEditable = "true";
 el.focus();

 const sel = window.getSelection();
 if (sel){
   const range = document.createRange();
   range.selectNodeContents(el);
   sel.removeAllRanges();
   sel.addRange(range);
 }

 function finish(saveIt){
   if (saveIt){
     const next = (el.textContent || "").trim();
     if (next) updateTaskField(id, "title", next);
     else el.textContent = t.title;
   } else {
     el.textContent = t.title;
   }
   el.contentEditable = "false";
   delete el.dataset.editing;
 }

 el.onkeydown = (ev) => {
   if (ev.key === "Enter"){
     ev.preventDefault();
     finish(true);
   } else if (ev.key === "Escape"){
     ev.preventDefault();
     finish(false);
   }
 };
 el.onblur = () => finish(true);
}

function groupByProject(list){
 const order = [];
 const map = new Map();
 for (const t of (list || [])){
   const key = t.project || "Algemeen";
   if (!map.has(key)){
     map.set(key, []);
     order.push(key);
   }
   map.get(key).push(t);
 }
 return order.map(project => ({ project, tasks: map.get(project) }));
}

function createTaskCard(t){
 const prog = checklistProgress(t);
 const progText = prog.total ? `${prog.done}/${prog.total}` : `0/0`;
 const labels = splitTags(t.tags);
 const projectColor = getProjectColor(t.project);
 const checklistItems = checklistForRender(t);

 const card = document.createElement("div");
 card.className = "task-card";
 if (!t.planned) card.classList.add("unplanned");
 if (t.status === "Done") card.classList.add("done-row");
 card.classList.add(`pri-${t.priority || "Medium"}`);

 card.innerHTML = `
   <div class="task-card-top">
     <details data-close-on-hide="1" data-taskid="${escapeAttr(t.id)}" ${openTaskIds.has(t.id) ? "open" : ""} ontoggle="toggleTaskOpen('${t.id}', this.open)">
       <summary>
         <div class="summary-row">
           <div style="flex:1; min-width:0;">
             <strong style="word-break:break-word;">
               <span class="task-title"
                     ondblclick="enableTitleEdit(event,'${t.id}', this)"
                     onclick="event.stopPropagation()">${escapeHtml(t.title)}</span>
             </strong>
             <div class="task-card-meta">
               ${t.project ? `<span class="pill"><span class="dot" style="background:${escapeAttr(projectColor)}"></span>${escapeHtml(t.project)}</span>` : ""}
               <span class="pill">${escapeHtml(t.priority)}</span>
               <span class="pill">${escapeHtml(t.status)}</span>
               <span class="pill">CL ${progText}</span>
               ${t.planned ? `<span class="pill">Gepland ${escapeHtml(t.planned)}</span>` : `<span class="pill">Niet ingepland</span>`}
               ${t.plannedEnd && t.plannedEnd !== t.planned ? `<span class="pill">Tot ${escapeHtml(t.plannedEnd)}</span>` : ``}
               ${t.deadline ? `<span class="pill">${stripTags(deadlineBadge(t))}</span>` : ``}
               ${labels.map(l => `<span class="pill"><span class="dot" style="background:${escapeAttr(getLabelColor(l))}"></span>${escapeHtml(l)}</span>`).join("")}
             </div>
           </div>
           <div class="small muted" style="white-space:nowrap;">Bewerk ▾</div>
         </div>
       </summary>

       ${t.notes ? `<div class="note"><strong class="small">Opmerkingen</strong>\n${escapeHtml(t.notes)}</div>` : ``}

       <div class="task-card-actions">
         <button class="btn" type="button" onclick="markDone('${t.id}')">Voltooi</button>
         <button class="btn" type="button" onclick="archiveTask('${t.id}')">Archiveer</button>
         <button class="btn" type="button" onclick="deleteTask('${t.id}')">Verwijder</button>
       </div>

       <div class="cl-wrap" style="margin-top:12px;">
         <div class="cl-head">
           <strong>Mini-checklist</strong>
           <span class="small">${progText}</span>
         </div>

         <div class="mini-row" style="margin-top:8px;">
           <input id="cl_new_${t.id}" placeholder="Checklist item toevoegen">
           <button class="btn btn-small" type="button" onclick="addChecklistItem('${t.id}')">+</button>
         </div>

         <ul class="cl-list">
           ${checklistItems.map(it => `
             <li class="cl-item">
               <input type="checkbox"
                      ${it.done ? "checked" : ""}
                      onchange="toggleChecklistItem('${t.id}','${it.id}', this.checked)">
               <span class="txt ${it.done ? "done" : ""}"
                     ondblclick="enableChecklistEdit(event,'${t.id}','${it.id}', this)">${escapeHtml(it.text)}</span>
               <button class="btn btn-small" type="button" aria-label="Omhoog"
                       onclick="moveChecklistItem('${t.id}','${it.id}', -1)">↑</button>
               <button class="btn btn-small" type="button" aria-label="Omlaag"
                       onclick="moveChecklistItem('${t.id}','${it.id}', 1)">↓</button>
               <button class="btn btn-small" type="button" onclick="deleteChecklistItem('${t.id}','${it.id}')">x</button>
             </li>
           `).join("")}
         </ul>
         ${checklistItems.length === 0 ? `<div class="small muted">Nog geen checklist items.</div>` : ``}
       </div>

       <div class="task-card-edit">
         <div class="small muted">Aangemaakt: ${new Date(t.created).toLocaleString()} · Laatst gewijzigd: ${new Date(t.updated||t.created).toLocaleString()}</div>

         <label>Project</label>
         <select onchange="updateTaskField('${t.id}','project',this.value)">
           ${getProjectNames().map(p => `<option ${p===t.project?'selected':''}>${escapeHtml(p)}</option>`).join("")}
         </select>

         <label>Prioriteit</label>
         <select onchange="updateTaskField('${t.id}','priority',this.value)">
           ${opt("High", t.priority)}${opt("Medium", t.priority)}${opt("Low", t.priority)}
         </select>

         <label>Status</label>
         <select onchange="updateTaskField('${t.id}','status',this.value)">
           ${opt("Todo", t.status)}${opt("Planned", t.status)}${opt("Done", t.status)}${opt("Archived", t.status)}
         </select>

         <label>Schatting (uren)</label>
         <input type="number" min="0" step="0.5"
                value="${escapeAttr(String(t.estimateHours ?? 0))}"
                onchange="updateTaskField('${t.id}','estimateHours', this.value==='' ? '' : Number(this.value))">

         <label>Datum inplannen</label>
         <input type="date"
                value="${escapeAttr(t.planned||"")}"
                onchange="updateTaskField('${t.id}','planned', this.value)">

         <label>Einddatum planning</label>
         <input type="date"
                value="${escapeAttr(t.plannedEnd||"")}"
                onchange="updateTaskField('${t.id}','plannedEnd', this.value)">

         <div class="row" style="margin-top:6px;">
           <button class="btn" type="button" onclick="planToday('${t.id}')">Plan vandaag</button>
           <button class="btn" type="button" onclick="clearPlan('${t.id}')">Planning wissen</button>
         </div>

         <label>Deadline</label>
         <input type="date"
                value="${escapeAttr(t.deadline||"")}"
                onchange="updateTaskField('${t.id}','deadline', this.value)">

         <label>Labels (komma-gescheiden)</label>
         <input value="${escapeAttr(t.tags||"")}"
                onchange="updateTaskField('${t.id}','tags', this.value)">

         <label>Opmerkingen</label>
         <textarea rows="3"
                   onchange="updateTaskField('${t.id}','notes', this.value)">${escapeHtml(t.notes||"")}</textarea>
       </div>

     </details>
   </div>
 `;

 return card;
}

function createWeekTaskCard(t){
 const projectColor = getProjectColor(t.project);
 const labels = splitTags(t.tags);
 const checklistItems = checklistForRender(t);

 const card = document.createElement("div");
 card.className = `week-task pri-${t.priority || "Medium"}`;
 if (t.status === "Done") card.classList.add("done-row");

 card.innerHTML = `
   <details data-close-on-hide="1">
     <summary>
       <div class="week-summary-row">
         <div style="flex:1; min-width:0;">
           <div class="week-task-title">${escapeHtml(t.title)}</div>

          <div class="week-task-meta">
            ${t.project ? `<span class="pill"><span class="dot" style="background:${escapeAttr(projectColor)}"></span>${escapeHtml(t.project)}</span>` : ``}
            ${t.notes ? `<span class="pill">Opmerking</span>` : ``}
          </div>
          ${checklistItems.length ? `
            <ul class="week-cl-summary">
              ${checklistItems.map(it => `
                <li class="${it.done ? "done" : ""}">
                  <input type="checkbox"
                         ${it.done ? "checked" : ""}
                         onclick="event.stopPropagation()"
                         onchange="toggleChecklistItem('${t.id}','${it.id}', this.checked)">
                  <span class="txt ${it.done ? "done" : ""}"
                        ondblclick="enableChecklistEdit(event,'${t.id}','${it.id}', this)">${escapeHtml(it.text)}</span>
                </li>
              `).join("")}
            </ul>
          ` : ``}
        </div>
        <div class="small muted" style="white-space:nowrap;">▾</div>
      </div>
    </summary>

    <div class="week-task-meta" style="margin-top:8px;">
      <span class="pill">${escapeHtml(t.priority)}</span>
      <span class="pill">${escapeHtml(t.status)}</span>
      ${t.deadline ? `<span class="pill">${stripTags(deadlineBadge(t))}</span>` : ``}
      ${labels.map(l => `<span class="pill"><span class="dot" style="background:${escapeAttr(getLabelColor(l))}"></span>${escapeHtml(l)}</span>`).join("")}
    </div>

    ${t.notes ? `<div class="note"><strong class="small">Opmerkingen</strong>\n${escapeHtml(t.notes)}</div>` : ``}

     ${checklistItems.length === 0 ? `` : `
       <div class="week-cl">
         <ul>
           ${checklistItems.map(it => `
             <li>
               <input type="checkbox"
                      ${it.done ? "checked" : ""}
                      onchange="toggleChecklistItem('${t.id}','${it.id}', this.checked)">
               <span class="txt ${it.done ? "done" : ""}"
                     ondblclick="enableChecklistEdit(event,'${t.id}','${it.id}', this)">${escapeHtml(it.text)}</span>
             </li>
           `).join("")}
         </ul>
       </div>
     `}

     <label class="small" style="margin-top:8px;">Datum inplannen</label>
     <input type="date"
            value="${escapeAttr(t.planned||"")}"
            onchange="updateTaskField('${t.id}','planned', this.value)">

     <label class="small">Einddatum planning</label>
     <input type="date"
            value="${escapeAttr(t.plannedEnd||"")}"
            onchange="updateTaskField('${t.id}','plannedEnd', this.value)">

     <div class="week-actions">
       <button class="btn" type="button" onclick="markDone('${t.id}')">Voltooi</button>
       <button class="btn" type="button" onclick="archiveTask('${t.id}')">Archiveer</button>
       <button class="btn" type="button" onclick="clearPlan('${t.id}')">Uit dag halen</button>
     </div>
   </details>
 `;

 return card;
}

function renderTasks(){
 autoRollOverByToday();
 buildFilters();

 const listEl = document.getElementById("taskList");
 listEl.innerHTML = "";

 const query = (document.getElementById("q")?.value || "").trim().toLowerCase();
 const fProj = document.getElementById("fProject")?.value || "";
 const fStat = document.getElementById("fStatus")?.value || "";
 const showDone = (document.getElementById("showDone")?.value || "yes") === "yes";

 let list = sortTasks(state.tasks);

 list = list.filter(t => {
   if (!showDone && t.status === "Done") return false;
   if (fProj && t.project !== fProj) return false;
   if (fStat){
     if (fStat === "Archived") return t.status === "Archived";
     return t.status === fStat;
   }
   if (query){
     const hay = `${t.title} ${t.tags||""} ${t.notes||""}`.toLowerCase();
     if (!hay.includes(query)) return false;
   }
   return true;
 });
 const openList = list.filter(t => t.status !== "Done");
 const doneList = list.filter(t => t.status === "Done");
 list = openList.concat(doneList);

 if (list.length === 0){
   const empty = document.createElement("div");
   empty.className = "card";
   empty.innerHTML = `<div class="card-pad small muted">Geen taken gevonden.</div>`;
   listEl.appendChild(empty);
   return;
 }

 const openGroups = groupByProject(openList);
 const doneGroups = groupByProject(doneList).map(g => ({ ...g, done: true }));
 const allGroups = openGroups.concat(doneGroups);

 for (const group of allGroups){
   const groupEl = document.createElement("div");
   groupEl.className = "group-block";
   if (group.done) groupEl.classList.add("group-done");

   const projectColor = getProjectColor(group.project);
   groupEl.innerHTML = `
     <div class="group-head">
       <span class="pill"><span class="dot" style="background:${escapeAttr(projectColor)}"></span>${escapeHtml(group.project)}</span>
       ${group.done ? `<span class="badge">Done</span>` : ``}
     </div>
   `;

   const body = document.createElement("div");
   body.className = "group-body";
   for (const t of group.tasks) body.appendChild(createTaskCard(t));
   groupEl.appendChild(body);
   listEl.appendChild(groupEl);
 }

 observeDetails();
}

/** --- Week view --- **/
function changeWeek(n){
 const w = weekDate();
 w.setDate(w.getDate() + 7*n);
 setWeek(w);
 renderWeek();
}
function goThisWeek(){
 setWeek(new Date());
 renderWeek();
}

function renderWeek(){
 autoRollOverByToday();
 const w = weekDate();
 weekTitle.textContent = "Week vanaf " + w.toLocaleDateString();
 weekGrid.innerHTML = "";
 const isWorkweek = (state.settings && state.settings.weekMode === "workweek");
 weekGrid.classList.toggle("workweek", isWorkweek);
 const daysToShow = isWorkweek ? 5 : 7;
 const todayIso = ymdFromDate(new Date());

 for (let i=0; i<daysToShow; i++){
   const d = new Date(w);
   d.setDate(d.getDate() + i);
   const dIso = ymdFromDate(d);
   const isToday = dIso === todayIso;

   const dayTasksSorted = state.tasks
     .filter(t => taskSpansDate(t, dIso) && t.status !== "Archived")
     .sort((a,b) => ((b.created||0)-(a.created||0)));
   const openTasks = dayTasksSorted.filter(t => t.status !== "Done");
   const doneTasks = dayTasksSorted.filter(t => t.status === "Done");
   const dayTasks = openTasks.concat(doneTasks);

  const dayDiv = document.createElement("div");
  dayDiv.className = `week-day${isToday ? " today" : ""}`;
  dayDiv.id = `daywrap_${dIso}`;

   dayDiv.innerHTML = `
     <div class="week-day-head">
       <div>
         <div class="week-day-name">${d.toLocaleDateString(undefined, { weekday: 'long' })}${isToday ? `<span class="week-today-badge">Vandaag</span>` : ``}</div>
         <div class="week-day-date">${escapeHtml(dIso)}</div>
       </div>
       <div class="small">${dayTasks.length} taak/taken</div>
     </div>
     <div class="week-day-body" id="day_${escapeAttr(dIso)}"></div>
   `;

   weekGrid.appendChild(dayDiv);

   const body = dayDiv.querySelector("#day_" + CSS.escape(dIso));
   if (!body) continue;

   if (dayTasks.length === 0){
     const empty = document.createElement("div");
     empty.className = "week-empty small muted";
     empty.textContent = "Geen taken gepland.";
     body.appendChild(empty);
     continue;
   }
   const openGroups = groupByProject(openTasks);
   const doneGroups = groupByProject(doneTasks).map(g => ({ ...g, done: true }));
   const dayGroups = openGroups.concat(doneGroups);

   for (const group of dayGroups){
     const groupEl = document.createElement("div");
     groupEl.className = "week-group";
     if (group.done) groupEl.classList.add("group-done");

     const projectColor = getProjectColor(group.project);
     groupEl.innerHTML = `
       <div class="week-group-head">
         <span class="pill"><span class="dot" style="background:${escapeAttr(projectColor)}"></span>${escapeHtml(group.project)}</span>
         ${group.done ? `<span class="badge">Done</span>` : ``}
       </div>
     `;

     const groupBody = document.createElement("div");
     groupBody.className = "week-group-body";
     for (const t of group.tasks) groupBody.appendChild(createWeekTaskCard(t));
     groupEl.appendChild(groupBody);
     body.appendChild(groupEl);
   }
 }

 observeDetails();
 focusTodayInWeek();
}

/** --- Settings: projects + labels --- **/
function renderSettings(){
 const ul = document.getElementById("projectList");
 ul.innerHTML = "";

 state.projects.forEach((p, idx) => {
   const li = document.createElement("li");
   li.className = "project-item";

   li.innerHTML = `
     <div class="project-title">
       <span class="project-name">${escapeHtml(p.name)}</span>
       ${idx===0 ? `<span class="small muted">(default)</span>` : ``}
     </div>
     <div class="project-divider"></div>

     <div class="project-inner">
       <div class="row project-controls">
         <input class="color-compact" type="color" value="${escapeAttr(p.color||"#4a90e2")}" onchange="setProjectColor('${escapeAttr(p.name)}', this.value)">
         <input type="text" value="${escapeAttr(p.name)}" placeholder="Projectnaam">
         <button class="btn btn-small" type="button" onclick="renameProject('${escapeAttr(p.name)}', this.previousElementSibling.value)">Naam wijzigen</button>
       </div>

       <div class="project-actions">
         <button class="btn-inline btn-inline-primary" type="button"
                 onclick="generateProjectPDF('${escapeAttr(p.name)}', { includeGantt:true })">
           Genereer PDF + Gantt
         </button>

         <button class="btn-inline" type="button"
                 onclick="generateProjectPDF('${escapeAttr(p.name)}', { includeGantt:false })">
           Genereer PDF
         </button>

        ${idx===0
           ? `<button class="btn" type="button" style="width:auto;" disabled
                     title="Default project kan niet verwijderd worden.">Verwijderen</button>`
           : `<button class="btn" type="button" style="width:auto;"
                      onclick="removeProject('${escapeAttr(p.name)}')">Verwijderen</button>`}
      </div>
      ${idx===0 ? `<div class="small muted project-note">Default project kan niet verwijderd worden.</div>` : ``}
    </div>
   `;
   ul.appendChild(li);
 });

 const lul = document.getElementById("labelList");
 lul.innerHTML = "";
 (state.labels||[]).forEach(l => {
   const li = document.createElement("li");
   li.style.margin = "8px 0";
   li.innerHTML = `
     <span class="pill" style="margin:0;">
       <span class="dot" style="background:${escapeAttr(l.color||"#7b7b7b")}"></span>
       ${escapeHtml(l.name)}
     </span>
     <div class="row" style="margin-top:6px;">
       <input class="color-compact" type="color" value="${escapeAttr(l.color||"#7b7b7b")}" onchange="setLabelColor('${escapeAttr(l.name)}', this.value)">
       <button class="btn" type="button" onclick="removeLabel('${escapeAttr(l.name)}')">Verwijderen</button>
     </div>
   `;
   lul.appendChild(li);
 });

 emailTo.value = state.settings.emailTo || "";
 notifyHour.value = state.settings.notifyHour ?? 12;
 notifyMinute.value = state.settings.notifyMinute ?? 0;
 weekMode.value = state.settings.weekMode || "full";

 renderCreate();
 rerenderVisible();
}

function addProject(){
 const name = (newProject.value || "").trim();
 if (!name) return;
 if (getProjectNames().includes(name)) { alert("Project bestaat al."); return; }

 const color = String(newProjectColor.value || "#4a90e2");
 state.projects.push({ name, color });
 save();
 newProject.value = "";
 renderSettings();
}
function renameProject(oldName, nextName){
 const from = String(oldName || "").trim();
 const to = String(nextName || "").trim();
 if (!from || !to) { alert("Projectnaam mag niet leeg zijn."); return; }
 if (from === to) return;
 if (getProjectNames().includes(to)) { alert("Project bestaat al."); return; }

 const p = state.projects.find(x => x.name === from);
 if (!p) return;
 p.name = to;

 state.tasks = state.tasks.map(t => (t.project === from ? { ...t, project: to } : t));
 save();
 renderSettings();
}
function setProjectColor(name, color){
 const p = state.projects.find(x => x.name === name);
 if (!p) return;
 p.color = String(color || "#4a90e2");
 save();
 rerenderVisible();
}
function removeProject(name){
 const used = state.tasks.some(t => t.project === name);
 if (used) { alert("Project wordt nog gebruikt in taken. Pas eerst die taken aan."); return; }

 const idx = state.projects.findIndex(p => p.name === name);
 if (idx <= 0) { alert("Default project kan niet worden verwijderd."); return; }

 state.projects.splice(idx,1);
 if (state.projects.length === 0) state.projects = [{ name:"Algemeen", color:"#4a90e2" }];
 save();
 renderSettings();
}

function addLabel(){
 const name = (newLabel.value || "").trim();
 if (!name) return;
 const exists = (state.labels||[]).some(l => l.name.toLowerCase() === name.toLowerCase());
 if (exists) { alert("Label bestaat al."); return; }

 const color = String(newLabelColor.value || "#7b7b7b");
 state.labels = normalizeLabels([...(state.labels||[]), { name, color }]);
 save();
 newLabel.value = "";
 renderSettings();
}
function setLabelColor(name, color){
 const l = (state.labels||[]).find(x => x.name.toLowerCase() === String(name||"").toLowerCase());
 if (!l) return;
 l.color = String(color || "#7b7b7b");
 save();
 rerenderVisible();
}
function removeLabel(name){
 state.labels = (state.labels||[]).filter(l => l.name.toLowerCase() !== String(name||"").toLowerCase());
 save();
 renderSettings();
}

function setWeekMode(value){
 if (!state.settings) state.settings = { emailTo:"", notifyHour:12, notifyMinute:0, weekMode:"full" };
 const prevMode = state.settings.weekMode || "full";
 const nextMode = (value === "workweek") ? "workweek" : "full";
 state.settings.weekMode = nextMode;

 let shifted = false;
 if (nextMode === "workweek"){
   for (const t of (state.tasks || [])){
     if (t.status === "Done" || t.status === "Archived") continue;
     if (bumpWeekendPlanned(t)) shifted = true;
   }
 }

 save();
 if (shifted) rerenderVisible();
 if (typeof weekMode !== "undefined") weekMode.value = nextMode;
 if (!document.getElementById("week").hidden) renderWeek();
}

function saveSettings(){
 state.settings.emailTo = (emailTo.value || "").trim();
 state.settings.notifyHour = clampInt(notifyHour.value, 12);
 state.settings.notifyMinute = clampInt(notifyMinute.value, 0);
 save();
 alert("Settings opgeslagen.");
}

/** -----------------------
*  CSV Export / Import
*  ----------------------- **/
function csvEscape(v){
 const s = String(v ?? "");
 if (/[",\n\r]/.test(s)){
   return `"${s.replaceAll('"','""')}"`;
 }
 return s;
}
function csvLine(arr){ return arr.map(csvEscape).join(",") + "\n"; }

function exportCSV(){
 const header = [
   "TYPE",
   "id","title","project","priority","status","estimateHours","planned","plannedEnd","deadline","tags","notes","created","updated","checklistJson",
   "name","color",
   "emailTo","notifyHour","notifyMinute"
 ];

 let out = "";
 out += csvLine(header);

  out += csvLine([
   "SETTINGS",
   "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
   "", "",
   state.settings.emailTo || "",
   state.settings.notifyHour ?? 12,
   state.settings.notifyMinute ?? 0
 ]);

 for (const p of (state.projects||[])){
  out += csvLine([
    "PROJECT",
    "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
    p.name || "",
    p.color || "",
    "", "", ""
  ]);
 }

 for (const l of (state.labels||[])){
  out += csvLine([
    "LABEL",
    "", "", "", "", "", "", "", "", "", "", "", "", "", "", "",
    l.name || "",
    l.color || "",
    "", "", ""
  ]);
 }

 for (const t of (state.tasks||[])){
  out += csvLine([
    "TASK",
    t.id || "",
    t.title || "",
    t.project || "",
    t.priority || "",
    t.status || "",
    (t.estimateHours ?? ""),
    t.planned || "",
    t.plannedEnd || "",
    t.deadline || "",
    t.tags || "",
    t.notes || "",
    t.created || "",
     t.updated || "",
     JSON.stringify(Array.isArray(t.checklist) ? t.checklist : []),
     "", "",
     "", "", ""
   ]);
 }

 const blob = new Blob([out], {type:"text/csv;charset=utf-8"});
 const url = URL.createObjectURL(blob);
 const a = document.createElement("a");
 a.href = url;
 a.download = "taakplanner-export.csv";
 document.body.appendChild(a);
 a.click();
 a.remove();
 URL.revokeObjectURL(url);
}

function parseCSV(text){
 const rows = [];
 let i = 0, field = "", row = [], inQuotes = false;

 function pushField(){
   row.push(field);
   field = "";
 }
 function pushRow(){
   rows.push(row);
   row = [];
 }

 while (i < text.length){
   const c = text[i];

   if (inQuotes){
     if (c === '"'){
       const next = text[i+1];
       if (next === '"'){ field += '"'; i += 2; continue; }
       inQuotes = false; i++; continue;
     } else {
       field += c; i++; continue;
     }
   } else {
     if (c === '"'){ inQuotes = true; i++; continue; }
     if (c === ","){ pushField(); i++; continue; }
     if (c === "\r"){ i++; continue; }
     if (c === "\n"){
       pushField();
       pushRow();
       i++; continue;
     }
     field += c; i++; continue;
   }
 }
 pushField();
 if (!(row.length === 1 && row[0] === "")) pushRow();

 return rows;
}

function importCSV(e){
 const file = e.target.files && e.target.files[0];
 if (!file) return;

 const r = new FileReader();
 r.onload = () => {
   try{
     const txt = String(r.result || "");
     const rows = parseCSV(txt);
     if (!rows.length) throw new Error("empty");

     const header = rows[0].map(h => String(h||"").trim());
     const idx = Object.fromEntries(header.map((h, i) => [h, i]));

     if (!("TYPE" in idx)) throw new Error("missing TYPE header");

     const next = defaultState();

     for (let ri=1; ri<rows.length; ri++){
       const row = rows[ri];
       const type = String(row[idx.TYPE] || "").trim().toUpperCase();

       if (type === "SETTINGS"){
         next.settings.emailTo = String(row[idx.emailTo] ?? "");
         next.settings.notifyHour = clampInt(row[idx.notifyHour], 12);
         next.settings.notifyMinute = clampInt(row[idx.notifyMinute], 0);
       }

       if (type === "PROJECT"){
         const name = String(row[idx.name] ?? "").trim();
         if (!name) continue;
         const color = String(row[idx.color] ?? "#4a90e2");
         next.projects.push({ name, color });
       }

       if (type === "LABEL"){
         const name = String(row[idx.name] ?? "").trim();
         if (!name) continue;
         const color = String(row[idx.color] ?? "#7b7b7b");
         next.labels.push({ name, color });
       }

       if (type === "TASK"){
         const t = {
           id: String(row[idx.id] ?? "").trim() || uid(),
           title: String(row[idx.title] ?? "").trim(),
           project: String(row[idx.project] ?? "").trim() || "Algemeen",
           priority: String(row[idx.priority] ?? "Medium") || "Medium",
           status: String(row[idx.status] ?? "Todo") || "Todo",
           estimateHours: (row[idx.estimateHours] === "" ? "" : Number(row[idx.estimateHours] ?? 1)),
           planned: String(row[idx.planned] ?? "").trim(),
           plannedEnd: String(row[idx.plannedEnd] ?? "").trim(),
           deadline: String(row[idx.deadline] ?? "").trim(),
           tags: String(row[idx.tags] ?? "").trim(),
           notes: String(row[idx.notes] ?? ""),
           created: Number(row[idx.created] ?? Date.now()) || Date.now(),
           updated: Number(row[idx.updated] ?? Date.now()) || Date.now(),
           checklist: []
         };

         const cl = String(row[idx.checklistJson] ?? "").trim();
         if (cl){
           try{
             const parsed = JSON.parse(cl);
             if (Array.isArray(parsed)) t.checklist = parsed;
           }catch{}
         }

         next.tasks.push(migrateTask(t));
       }
     }

     next.projects = normalizeProjects(next.projects);
     next.labels = normalizeLabels(next.labels);
     if (!next.week) next.week = startOfWeek(new Date()).toISOString();

     setState(next);
     save();
     alert("Import gelukt.");
     renderSettings();
     show("tasks");
   }catch(err){
     console.error(err);
     alert("Import mislukt: CSV is niet geldig voor deze app.");
   }finally{
     e.target.value = "";
   }
 };
 r.readAsText(file);
}

function resetAll(){
 if (!confirm("Weet je zeker dat je alles wilt wissen?")) return;
 localStorage.removeItem(KEY);
 setState(defaultState());
 save();
 show("create");
}

/** --- utils --- */
function opt(v, cur){ return `<option ${v===cur?'selected':''}>${v}</option>`; }
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }
function stripTags(html){
 const tmp = document.createElement("div");
 tmp.innerHTML = html;
 return escapeHtml(tmp.textContent || "");
}

/** --- helpers for Firebase script --- **/
window.__applyCloudState = function(cloudState){
 if (!cloudState || typeof cloudState !== "object") return;

 const s = cloudState;

 if (!Array.isArray(s.tasks)) s.tasks = [];
 if (!s.week) s.week = startOfWeek(new Date()).toISOString();

 s.projects = normalizeProjects(s.projects);
 s.labels = normalizeLabels(s.labels);

 if (!s.settings) s.settings = { emailTo:"", notifyHour:12, notifyMinute:0, weekMode:"full" };
 s.settings.notifyHour = clampInt(s.settings.notifyHour, 12);
 s.settings.notifyMinute = clampInt(s.settings.notifyMinute, 0);
 s.settings.emailTo = String(s.settings.emailTo ?? "");
 s.settings.weekMode = (s.settings.weekMode === "workweek") ? "workweek" : "full";

 s.tasks = s.tasks.map(migrateTask);

 setState(s);
 save();
 renderCreate();
 rerenderVisible();
};

initPullToRefresh();

/** --------------------------
*  PDF export per project
*  -------------------------- */
function safeFileName(s){
 return String(s || "project").trim().replace(/[\/\\?%*:|"<>]/g, "-").replace(/\s+/g, "_");
}
function fmtDateNL(ymd){
 const d = dateFromYMD(ymd);
 return d ? d.toLocaleDateString("nl-NL") : (ymd || "");
}
function fmtGanttTick(dt, includeYear){
 const opts = { day:"2-digit", month:"short" };
 if (includeYear) opts.year = "numeric";
 return dt.toLocaleDateString("nl-NL", opts);
}
function taskGanttRange(t){
 const start = dateFromYMD(t.planned) || dateFromYMD(t.deadline);
 const end = dateFromYMD(t.plannedEnd) || dateFromYMD(t.deadline) || dateFromYMD(t.planned);
 if (!start && !end) return null;

 const s = start ? new Date(start) : new Date(end);
 const e = end ? new Date(end) : new Date(start);

 if (s && e && e.getTime() < s.getTime()){
   const tmp = new Date(s); s.setTime(e.getTime()); e.setTime(tmp.getTime());
 }
 e.setDate(e.getDate() + 1);
 return { start: s, end: e };
}

function generateTotalPDF(opts){
 const includeGantt = !!(opts && opts.includeGantt);

 const tasks = (state.tasks || []).filter(t => t.status !== "Archived");
 const all = (state.tasks || []);

 if (!tasks.length && !all.length){
   alert("Geen taken gevonden.");
   return;
 }

 if (!window.jspdf || !window.jspdf.jsPDF){
   alert("PDF library niet geladen. Check je internetverbinding of de CDN scripts.");
   return;
 }

 const { jsPDF } = window.jspdf;
 const doc = new jsPDF({ unit:"pt", format:"a4" });

 const pageW = doc.internal.pageSize.getWidth();
 const pageH = doc.internal.pageSize.getHeight();
 const margin = 40;

 doc.setFont("helvetica","bold");
 doc.setFontSize(18);
 doc.text("Totale planning", margin, 55);

 doc.setFont("helvetica","normal");
 doc.setFontSize(10);
 doc.text(`Gegenereerd: ${new Date().toLocaleString("nl-NL")}`, margin, 72);

 doc.setDrawColor(0);
 doc.setFillColor(...hexToRgb("#2563eb"));
 doc.rect(pageW - margin - 80, 40, 80, 10, "F");

 const stats = {
   total: all.length,
   active: (all.filter(t => t.status !== "Archived")).length,
   todo: all.filter(t => t.status === "Todo").length,
   planned: all.filter(t => t.status === "Planned").length,
   done: all.filter(t => t.status === "Done").length
 };

 const estTotal = sumHours(all);
 const estOpen = sumHours(all.filter(t => t.status !== "Done" && t.status !== "Archived"));

 let y = 95;
 doc.setFontSize(12);
 doc.setFont("helvetica","bold");
 doc.text("Samenvatting", margin, y);
 y += 10;

 doc.setFont("helvetica","normal");
 doc.setFontSize(10);
 const lines = [
   `Totaal taken: ${stats.total} (actief: ${stats.active})`,
   `Status: Todo ${stats.todo} · Planned ${stats.planned} · Done ${stats.done}`,
   `Uren (schatting): totaal ${fmtHours(estTotal)} · open ${fmtHours(estOpen)}`
 ];
 y += 14;
 lines.forEach((l, i) => doc.text(l, margin, y + i*14));
 y += lines.length*14 + 10;

 const rows = sortTasks(tasks).map(t => {
   const prog = checklistProgress(t);
   const cl = prog.total ? `${prog.done}/${prog.total}` : "";
   return [
     t.title || "",
     t.project || "",
     t.status || "",
     t.priority || "",
     t.planned ? fmtDateNL(t.planned) : "",
     t.deadline ? fmtDateNL(t.deadline) : "",
     (t.estimateHours ?? "") !== "" ? String(t.estimateHours) : "",
     cl,
     (t.tags || "")
   ];
 });

 doc.setFont("helvetica","bold");
 doc.setFontSize(12);
 doc.text("Taken (niet-archived)", margin, y);
 y += 8;

 doc.autoTable({
   startY: y + 6,
   margin: { left: margin, right: margin },
   head: [["Taak", "Project", "Status", "Prio", "Gepland", "Deadline", "Uren", "CL", "Labels"]],
   body: rows,
   styles: { font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak" },
   headStyles: { fillColor: [37, 99, 235], textColor: 255 },
   columnStyles: {
     0: { cellWidth: 150 },
     1: { cellWidth: 70 },
     2: { cellWidth: 50 },
     3: { cellWidth: 40 },
     4: { cellWidth: 60 },
     5: { cellWidth: 60 },
     6: { cellWidth: 35, halign:"right" },
     7: { cellWidth: 30, halign:"center" },
     8: { cellWidth: 85 }
   }
 });

 let afterTableY = doc.lastAutoTable.finalY + 18;

 const withNotes = tasks.filter(t => String(t.notes||"").trim().length > 0).slice(0, 12);
 if (withNotes.length){
   if (afterTableY > pageH - 120){
     doc.addPage();
     afterTableY = margin;
   }
   doc.setFont("helvetica","bold");
   doc.setFontSize(12);
   doc.text("Opmerkingen (selectie)", margin, afterTableY);
   afterTableY += 10;

   doc.setFont("helvetica","normal");
   doc.setFontSize(9);
   for (const t of withNotes){
     const prefix = t.project ? `${t.project} - ${t.title}` : t.title;
     const block = `${prefix}: ${String(t.notes).trim()}`;
     const wrapped = doc.splitTextToSize(block, pageW - margin*2);
     if (afterTableY + wrapped.length*11 > pageH - margin){
       doc.addPage();
       afterTableY = margin;
     }
     doc.text(wrapped, margin, afterTableY + 12);
     afterTableY += wrapped.length*11 + 10;
   }
 }

 if (includeGantt){
   doc.addPage();
   drawGantt(doc, "Totale planning", tasks, margin);
 }

 const suffix = includeGantt ? "_gantt" : "";
 doc.save(`totale_planning${suffix}.pdf`);
}

function generateProjectPDF(projectName, opts){
 const includeGantt = !!(opts && opts.includeGantt);

 const tasks = (state.tasks || []).filter(t => t.project === projectName && t.status !== "Archived");
 const all = (state.tasks || []).filter(t => t.project === projectName);

 if (!tasks.length && !all.length){
   alert("Geen taken gevonden voor dit project.");
   return;
 }

 if (!window.jspdf || !window.jspdf.jsPDF){
   alert("PDF library niet geladen. Check je internetverbinding of de CDN scripts.");
   return;
 }

 const { jsPDF } = window.jspdf;
 const doc = new jsPDF({ unit:"pt", format:"a4" });

 const pageW = doc.internal.pageSize.getWidth();
 const pageH = doc.internal.pageSize.getHeight();
 const margin = 40;

 const projectColor = getProjectColor(projectName);

 doc.setFont("helvetica","bold");
 doc.setFontSize(18);
 doc.text(`Project: ${projectName}`, margin, 55);

 doc.setFont("helvetica","normal");
 doc.setFontSize(10);
 doc.text(`Gegenereerd: ${new Date().toLocaleString("nl-NL")}`, margin, 72);

 doc.setDrawColor(0);
 doc.setFillColor(...hexToRgb(projectColor));
 doc.rect(pageW - margin - 80, 40, 80, 10, "F");

 const stats = {
   total: all.length,
   active: (all.filter(t => t.status !== "Archived")).length,
   todo: all.filter(t => t.status === "Todo").length,
   planned: all.filter(t => t.status === "Planned").length,
   done: all.filter(t => t.status === "Done").length
 };

 const estTotal = sumHours(all);
 const estOpen = sumHours(all.filter(t => t.status !== "Done" && t.status !== "Archived"));

 let y = 95;
 doc.setFontSize(12);
 doc.setFont("helvetica","bold");
 doc.text("Samenvatting", margin, y);
 y += 10;

 doc.setFont("helvetica","normal");
 doc.setFontSize(10);
 const lines = [
   `Totaal taken: ${stats.total} (actief: ${stats.active})`,
   `Status: Todo ${stats.todo} · Planned ${stats.planned} · Done ${stats.done}`,
   `Uren (schatting): totaal ${fmtHours(estTotal)} · open ${fmtHours(estOpen)}`
 ];
 y += 14;
 lines.forEach((l, i) => doc.text(l, margin, y + i*14));
 y += lines.length*14 + 10;

 const rows = sortTasks(tasks).map(t => {
   const prog = checklistProgress(t);
   const cl = prog.total ? `${prog.done}/${prog.total}` : "";
   return [
     t.title || "",
     t.status || "",
     t.priority || "",
     t.planned ? fmtDateNL(t.planned) : "",
     t.deadline ? fmtDateNL(t.deadline) : "",
     (t.estimateHours ?? "") !== "" ? String(t.estimateHours) : "",
     cl,
     (t.tags || "")
   ];
 });

 doc.setFont("helvetica","bold");
 doc.setFontSize(12);
 doc.text("Taken (niet-archived)", margin, y);
 y += 8;

 doc.autoTable({
   startY: y + 6,
   margin: { left: margin, right: margin },
   head: [["Taak", "Status", "Prio", "Gepland", "Deadline", "Uren", "CL", "Labels"]],
   body: rows,
   styles: { font: "helvetica", fontSize: 8, cellPadding: 4, overflow: "linebreak" },
   headStyles: { fillColor: [37, 99, 235], textColor: 255 },
   columnStyles: {
     0: { cellWidth: 170 },
     1: { cellWidth: 55 },
     2: { cellWidth: 45 },
     3: { cellWidth: 60 },
     4: { cellWidth: 60 },
     5: { cellWidth: 35, halign:"right" },
     6: { cellWidth: 35, halign:"center" },
     7: { cellWidth: 90 }
   }
 });

 let afterTableY = doc.lastAutoTable.finalY + 18;

 const withNotes = tasks.filter(t => String(t.notes||"").trim().length > 0).slice(0, 12);
 if (withNotes.length){
   if (afterTableY > pageH - 120){
     doc.addPage();
     afterTableY = margin;
   }
   doc.setFont("helvetica","bold");
   doc.setFontSize(12);
   doc.text("Opmerkingen (selectie)", margin, afterTableY);
   afterTableY += 10;

   doc.setFont("helvetica","normal");
   doc.setFontSize(9);
   for (const t of withNotes){
     const prefix = t.project ? `${t.project} - ${t.title}` : t.title;
     const block = `${prefix}: ${String(t.notes).trim()}`;
     const wrapped = doc.splitTextToSize(block, pageW - margin*2);
     if (afterTableY + wrapped.length*11 > pageH - margin){
       doc.addPage();
       afterTableY = margin;
     }
     doc.text(wrapped, margin, afterTableY + 12);
     afterTableY += wrapped.length*11 + 10;
   }
 }

 if (includeGantt){
   doc.addPage();
   drawGantt(doc, projectName, tasks, margin);
 }

 doc.save(`${safeFileName(projectName)}_taken.pdf`);
}

function sumHours(list){
 let s = 0;
 for (const t of (list||[])){
   const n = Number(t.estimateHours);
   if (Number.isFinite(n)) s += n;
 }
 return s;
}
function fmtHours(n){
 const x = Number(n);
 if (!Number.isFinite(x)) return "0";
 if (Math.abs(x - Math.round(x)) < 1e-9) return String(Math.round(x));
 return String(Math.round(x*10)/10);
}
function hexToRgb(hex){
 const h = String(hex || "#000000").replace("#","");
 if (h.length === 3){
   const r = parseInt(h[0]+h[0],16);
   const g = parseInt(h[1]+h[1],16);
   const b = parseInt(h[2]+h[2],16);
   return [r,g,b];
 }
 if (h.length === 6){
   const r = parseInt(h.slice(0,2),16);
   const g = parseInt(h.slice(2,4),16);
   const b = parseInt(h.slice(4,6),16);
   return [r,g,b];
 }
 return [0,0,0];
}

function drawGantt(doc, projectName, tasks, margin){
 const pageW = doc.internal.pageSize.getWidth();
 const pageH = doc.internal.pageSize.getHeight();

 const ganttItems = tasks
   .map(t => ({ t, r: taskGanttRange(t) }))
   .filter(x => x.r)
   .sort((a, b) => (a.r.start.getTime() - b.r.start.getTime()));

 if (!ganttItems.length){
   doc.setFont("helvetica","normal");
   doc.setFontSize(11);
   doc.text("Geen (geplande datum/deadline) beschikbaar om een Gantt te tekenen.", margin, 85);
   return;
 }

 let minD = ganttItems[0].r.start;
 let maxD = ganttItems[0].r.end;
 for (const it of ganttItems){
   if (it.r.start.getTime() < minD.getTime()) minD = it.r.start;
   if (it.r.end.getTime() > maxD.getTime()) maxD = it.r.end;
 }
 minD = new Date(minD); minD.setHours(0,0,0,0);
 maxD = new Date(maxD); maxD.setHours(0,0,0,0);

 const maxPlus = new Date(maxD);
 maxPlus.setDate(maxPlus.getDate() + 1);

 const totalRangeDays = Math.max(1, Math.round((maxPlus - minD) / 86400000));
 const windowDays = 21;
 let pageIndex = 0;

 function drawWindowFrame(winStart, winEnd, titleSuffix, chartBottomY){
   doc.setFont("helvetica","bold");
   doc.setFontSize(15);
   doc.text(`Gantt - ${projectName}${titleSuffix}`, margin, 55);

   doc.setFont("helvetica","normal");
   doc.setFontSize(8);
   doc.setTextColor(90);
   doc.text(
     `Periode: ${winStart.toLocaleDateString("nl-NL")} → ${new Date(winEnd.getTime()-86400000).toLocaleDateString("nl-NL")}`,
     margin,
     68
   );
   doc.setTextColor(0);

   const chartX = margin;
   const chartY = 90;
   const chartW = pageW - margin*2;
   const labelW = 190;
   const barX = chartX + labelW;
   const barW = chartW - labelW;
   const chartTop = chartY - 12;
   const chartBottom = chartBottomY || (pageH - margin);
   const chartH = Math.max(40, chartBottom - chartTop);

   doc.setFillColor(255,255,255);
   doc.rect(chartX, chartTop, labelW, chartH, "F");
   doc.setFillColor(251,251,251);
   doc.rect(barX, chartTop, barW, chartH, "F");

   const dayW = barW / windowDays;
   doc.setFillColor(238,238,238);
   for (let d=0; d<windowDays; d++){
     const dt = new Date(winStart);
     dt.setDate(dt.getDate() + d);
     const day = dt.getDay();
     if (day === 0 || day === 6){
       const x = barX + (d/windowDays)*barW;
       doc.rect(x, chartTop, dayW, chartH, "F");
       doc.setDrawColor(200);
       doc.setLineWidth(1);
       doc.line(x + dayW/2, chartTop, x + dayW/2, chartBottom);
     }
   }
   doc.setLineWidth(0.2);

   doc.setDrawColor(210);
   doc.setFont("helvetica","normal");
   doc.setFontSize(6);
   doc.setTextColor(110);
   const labelY = chartTop - 6;
   for (let d=0; d<=windowDays; d++){
     const x = barX + (d/windowDays)*barW;
     doc.line(x, chartY-10, x, chartBottom);
     if (d < windowDays){
       const dt = new Date(winStart);
       dt.setDate(dt.getDate() + d);
       const txt = dt.toLocaleDateString("nl-NL",{ day:"2-digit", month:"2-digit" });
       const midX = barX + ((d + 0.5)/windowDays)*barW;
       doc.text(txt, midX + 1, labelY, { angle: 90 });
     }
   }
   doc.setTextColor(0);

   return { chartX, chartY, barX, barW };
 }

 for (let offset=0; offset<totalRangeDays; offset+=windowDays){
   const winStart = new Date(minD);
   winStart.setDate(winStart.getDate() + offset);
   const winEnd = new Date(winStart);
   winEnd.setDate(winEnd.getDate() + windowDays);

   const windowItems = ganttItems
     .filter(it => it.r.end > winStart && it.r.start < winEnd)
     .sort((a, b) => {
       const d = a.r.start.getTime() - b.r.start.getTime();
       if (d !== 0) return d;
       return String(a.t.title || "").localeCompare(String(b.t.title || ""));
     });
   if (!windowItems.length) continue;

   const rowH = 14;
   const baseY = 90 + 12;
   const rowsPerPage = Math.max(1, Math.floor(((pageH - margin - 30) - baseY) / rowH));
   let index = 0;
   while (index < windowItems.length){
     if (pageIndex > 0) doc.addPage();
     pageIndex++;
     const rowsThisPage = Math.min(rowsPerPage, windowItems.length - index);
     const chartBottom = baseY + rowsThisPage * rowH - 2;
     const titleSuffix = (pageIndex > 1) ? " (vervolg)" : "";
     const frame = drawWindowFrame(winStart, winEnd, titleSuffix, chartBottom);

     let y = frame.chartY + 12;
     doc.setDrawColor(232);

     for (let i = 0; i < rowsThisPage; i++){
       const it = windowItems[index + i];
       const rowIndex = index + i;

      const t = it.t;
      const r = it.r;

      if (rowIndex % 2 === 0){
        doc.setFillColor(248,248,248);
        doc.rect(frame.barX, y-10, frame.barW, rowH, "F");
     }

     const s = r.start < winStart ? winStart : r.start;
     const e = r.end > winEnd ? winEnd : r.end;
     const sDay = Math.max(0, Math.round((s - winStart)/86400000));
     const eDay = Math.max(0, Math.round((e - winStart)/86400000));

     doc.setFont("helvetica","normal");
     doc.setFontSize(8);
     const label = (t.title || "").slice(0, 65);
     doc.text(label, frame.chartX + 10, y);

     const sx = frame.barX + (sDay/windowDays)*frame.barW;
     const ex = frame.barX + (eDay/windowDays)*frame.barW;
     const w = Math.max(2, ex - sx);

     const fill = hexToRgb(getProjectColor(t.project));

     doc.setFillColor(fill[0], fill[1], fill[2]);
     doc.setDrawColor(210);
     if (typeof doc.roundedRect === "function"){
       doc.roundedRect(sx, y-8, w, 9, 2, 2, "F");
     } else {
       doc.rect(sx, y-8, w, 9, "F");
     }

     if (t.deadline){
       const dl = dateFromYMD(t.deadline);
       if (dl && dl >= winStart && dl < winEnd){
         const dlDay = Math.round((dl - winStart)/86400000);
         const mx = frame.barX + (dlDay/windowDays)*frame.barW;
         doc.setDrawColor(0);
         doc.line(mx, y-10, mx, y+2);
       }
     }

     doc.setDrawColor(232);
     doc.line(frame.chartX, y+4, frame.barX + frame.barW, y+4);
       y += rowH;
     }
     index += rowsThisPage;
   }

   doc.setFont("helvetica","normal");
   doc.setFontSize(9);
   doc.text("Legenda: balkkleur = project. Zwart streepje = deadline.", margin, pageH - margin);
 }
}
</script>

<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase Auth + Firestore -->
<script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
 import {
   getAuth,
   onAuthStateChanged,
   signInWithEmailAndPassword,
   createUserWithEmailAndPassword,
   signOut
 } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

 import {
   getFirestore,
   doc,
   getDoc,
   setDoc
 } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

 const firebaseConfig = {
   apiKey: "AIzaSyDexeK2_ZkUOHfa8jV5nDEoDQgXoE7fV3c",
   authDomain: "taakplanner-b0236.firebaseapp.com",
   projectId: "taakplanner-b0236",
   storageBucket: "taakplanner-b0236.firebasestorage.app",
   messagingSenderId: "131823414976",
   appId: "1:131823414976:web:78b6037693d247e9680725"
 };

 const app = initializeApp(firebaseConfig);
 const auth = getAuth(app);
 const db = getFirestore(app);

 const nav = document.querySelector("nav");
 const authGate = document.getElementById("authGate");
 const statusEl = document.getElementById("authStatus");
 const emailEl = document.getElementById("authEmail");
 const passEl = document.getElementById("authPass");
 const btnLogin = document.getElementById("btnLogin");
 const btnSignup = document.getElementById("btnSignup");
 const btnLogout = document.getElementById("btnLogout");

 function setStatus(msg){ statusEl.textContent = msg || ""; }

 function hideApp(){
   nav.style.display = "none";
   authGate.style.display = "";
   document.querySelectorAll("section").forEach(s => {
     if (s.id === "authGate") return;
     s.hidden = true;
   });
 }

 function showApp(){
   nav.style.display = "flex";
   authGate.style.display = "none";
   if (typeof window.show === "function") window.show("create");  // ✅ active tab wordt direct gezet
   if (typeof window.renderCreate === "function") window.renderCreate();
 }

 async function loadStateFromCloud(uid){
   const ref = doc(db, "users", uid, "state", "main");
   const snap = await getDoc(ref);
   return snap.exists() ? snap.data().state : null;
 }

 async function saveStateToCloud(uid, stateObj){
   const ref = doc(db, "users", uid, "state", "main");
   await setDoc(ref, { state: stateObj, updatedAt: Date.now() }, { merge: true });
 }

 window.__cloud = {
   currentUid: null,
   saveStateToCloud
 };

 btnLogin.addEventListener("click", async () => {
   setStatus("Inloggen...");
   try{
     await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
     setStatus("");
   }catch(e){
     setStatus("Login mislukt: " + (e?.message || e));
   }
 });

 btnSignup.addEventListener("click", async () => {
   setStatus("Account maken...");
   try{
     await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
     setStatus("Account gemaakt en ingelogd.");
   }catch(e){
     setStatus("Account maken mislukt: " + (e?.message || e));
   }
 });

 btnLogout.addEventListener("click", async () => {
   await signOut(auth);
 });

 onAuthStateChanged(auth, async (user) => {
   if (!user){
     window.__cloud.currentUid = null;
     btnLogout.hidden = true;
     setStatus("Niet ingelogd.");
     hideApp();
     return;
   }

   window.__cloud.currentUid = user.uid;
   btnLogout.hidden = false;
   setStatus("Ingelogd als: " + (user.email || user.uid));

   const cloudState = await loadStateFromCloud(user.uid);

   if (cloudState){
     if (typeof window.__applyCloudState === "function") window.__applyCloudState(cloudState);
   } else {
     if (window.state) await saveStateToCloud(user.uid, window.state);
   }

   showApp();
 });

 hideApp();
 console.log("Firebase Auth + Firestore actief");
</script>

</body>
</html>
