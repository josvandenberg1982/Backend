<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Taakplanner</title>

<style>
  :root{
    --border:#ddd;
    --muted:#666;
    --bg:#fff;
    --soft:#fafafa;
    --soft2:#f6f7f8;
    --danger:#b00020;
    --warn:#b36b00;
    --ok:#0b7a3b;
  }

  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:#111; }

  nav {
    display:flex; gap:12px; padding:12px; border-bottom:1px solid var(--border);
    position: sticky; top:0; background:var(--bg); z-index: 10;
  }

  section { padding:12px; max-width:1100px; margin:0 auto; }

  input, select, textarea, button { width:100%; margin:4px 0; box-sizing: border-box; }
  button { cursor:pointer; }
  table { width:100%; border-collapse: collapse; }
  td, th { border-bottom:1px solid var(--border); padding:8px; vertical-align: top; }
  th { text-align:left; background:var(--soft2); position:sticky; top:49px; z-index:5; }

  .small { font-size: 12px; color:var(--muted); }
  .muted { color:var(--muted); }
  .badge { display:inline-block; padding:2px 8px; border:1px solid #ccc; border-radius: 999px; font-size: 12px; background:#fff; }
  .pill  { display:inline-block; padding:2px 10px; border:1px solid #ccc; border-radius: 999px; font-size:12px; background:#fff; margin-right:6px; margin-top:4px; }
  .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
  .row > * { flex: 1 1 180px; }
  hr { border:0; border-top:1px solid #eee; margin:12px 0; }

  .note {
    white-space: pre-wrap;
    background:var(--soft);
    border:1px solid #eee;
    border-radius:10px;
    padding:8px;
    margin-top:6px;
    font-size: 13px;
  }

  /* Overall list */
  .unplanned { border-left: 4px solid #c90; }
  .done-row { opacity:.72; }
  .danger { color:var(--danger); border-color: rgba(176,0,32,.35); }
  .warn { color:var(--warn); border-color: rgba(179,107,0,.35); }
  .ok { color:var(--ok); border-color: rgba(11,122,59,.35); }

  /* Checklist (overall) */
  .cl-wrap { border:1px solid #eee; border-radius:10px; padding:8px; background:#fff; }
  .cl-head { display:flex; justify-content: space-between; gap:10px; align-items:center; }
  .cl-head strong { font-size: 13px; }
  .cl-list { list-style:none; padding:0; margin:8px 0 0 0; }
  .cl-item { display:flex; gap:8px; align-items:center; padding:4px 0; border-top:1px dashed #eee; }
  .cl-item:first-child { border-top:0; }
  .cl-item input[type="checkbox"] { width:auto; }
  .cl-item .txt { flex:1; }
  .cl-item .done { text-decoration: line-through; color:#777; }
  .mini-btn { width:auto; padding:6px 10px; }
  .mini-row { display:flex; gap:8px; align-items:center; }
  .mini-row > input { flex:1; }
  .mini-row > button { width:auto; }

  /* Week view: clearer separation */
  .week-grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media (min-width: 980px){
    .week-grid{
      grid-template-columns: repeat(7, 1fr);
      align-items: start;
    }
  }

  .week-day {
    border:1px solid var(--border);
    background:var(--soft2);
    border-radius:16px;
    overflow:hidden;
  }
  .week-day-head{
    padding:10px 12px;
    background:#fff;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:baseline;
  }
  .week-day-head strong{ font-size:14px; }
  .week-day-body{ padding:10px 10px 12px 10px; }
  .week-empty{
    padding:10px;
    border:1px dashed #ddd;
    border-radius:12px;
    background:#fff;
  }

  /* Tasks as cards, clearly separated */
  .week-task {
    background:#fff;
    border:1px solid #e7e7e7;
    border-radius:14px;
    padding:10px;
    margin-top:10px;
    box-shadow: 0 1px 0 rgba(0,0,0,.03);
  }
  .week-task:first-child{ margin-top:0; }

  .week-task-title {
    font-weight: 750;
    font-size: 16px;
    line-height: 1.25;
    margin-bottom: 6px;
    word-break: break-word;
  }

  .week-task-meta{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:2px;
  }

  /* Week checklist (interactive) */
  .week-cl { margin-top:10px; border-top:1px dashed #eee; padding-top:8px; }
  .week-cl ul { list-style:none; padding:0; margin:0; }
  .week-cl li {
    display:flex;
    gap:8px;
    align-items:flex-start;
    padding: 4px 0;
    font-size: 12px;
    color:#444;
  }
  .week-cl input[type="checkbox"]{ width:auto; margin-top:2px; }
  .week-cl .txt.done { text-decoration: line-through; color:#777; }
  .week-cl .more { font-size: 12px; color:var(--muted); margin-top: 2px; }

  /* Action buttons on week cards */
  .week-actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
    border-top:1px solid #f1f1f1;
    padding-top:10px;
  }
  .week-actions button{
    flex: 1 1 120px;
    margin:0;
  }

  /* Priority indicator */
  .pri-High{ border-left: 4px solid rgba(176,0,32,.55); }
  .pri-Medium{ border-left: 4px solid rgba(179,107,0,.55); }
  .pri-Low{ border-left: 4px solid rgba(11,122,59,.45); }
</style>
</head>

<body>
<nav>
  <button type="button" onclick="show('create')">Nieuwe taak</button>
  <button type="button" onclick="show('tasks')">Takenlijst</button>
  <button type="button" onclick="show('week')">Week</button>
  <button type="button" onclick="show('settings')">Settings</button>
</nav>

<section id="create">
  <h2>Nieuwe taak</h2>
  <form onsubmit="addTask(event)">
    <label>Taakomschrijving</label>
    <input id="title" required placeholder="Bijv. offerte maken, engineering, administratie">

    <div class="row">
      <div>
        <label>Project</label>
        <select id="createProject"></select>
      </div>
      <div>
        <label>Prioriteit</label>
        <select id="createPriority">
          <option>High</option>
          <option selected>Medium</option>
          <option>Low</option>
        </select>
      </div>
      <div>
        <label>Schatting (uren)</label>
        <input id="createEstimate" type="number" min="0" step="0.5" value="1">
      </div>
      <div>
        <label>Deadline</label>
        <input id="createDeadline" type="date">
      </div>
    </div>

    <button type="submit">Opslaan</button>
  </form>
  <div class="small">Na opslaan ga je automatisch naar de takenlijst.</div>
</section>

<section id="tasks" hidden>
  <h2>Overall takenlijst</h2>

  <div style="border:1px solid var(--border); background:#fff; border-radius:14px; padding:10px; margin-bottom:12px;">
    <div class="row">
      <div>
        <label>Zoeken</label>
        <input id="q" placeholder="Zoek in titel/tags/opmerkingen" oninput="renderTasks()">
      </div>
      <div>
        <label>Project</label>
        <select id="fProject" onchange="renderTasks()"></select>
      </div>
      <div>
        <label>Status</label>
        <select id="fStatus" onchange="renderTasks()">
          <option value="">Alle</option>
          <option>Todo</option>
          <option>Planned</option>
          <option>Done</option>
          <option value="Archived">Archived</option>
        </select>
      </div>
      <div>
        <label>Toon Done</label>
        <select id="showDone" onchange="renderTasks()">
          <option value="yes" selected>Ja</option>
          <option value="no">Nee</option>
        </select>
      </div>
    </div>

    <div class="small">
      Niet ingepland en nieuwste staan bovenaan. Tijdens datum kiezen wordt niet her-gesorteerd (bewust).
      Deadline krijgt een badge (overdue / binnenkort).
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:46%">Taak</th>
        <th style="width:54%">Plannen / bewerken</th>
      </tr>
    </thead>
    <tbody id="taskRows"></tbody>
  </table>
</section>

<section id="week" hidden>
  <h2 id="weekTitle"></h2>

  <div class="row">
    <button type="button" onclick="changeWeek(-1)">← Vorige</button>
    <button type="button" onclick="goThisWeek()">Deze week</button>
    <button type="button" onclick="changeWeek(1)">Volgende →</button>
  </div>

  <div class="small" style="margin-top:8px;">
    In weekoverzicht kun je checklist-items aanvinken en taken afronden/archiveren.
  </div>

  <div id="weekGrid" class="week-grid" style="margin-top:12px;"></div>
</section>

<section id="settings" hidden>
  <h2>Settings</h2>

  <h3>Projecten</h3>
  <div class="row">
    <input id="newProject" placeholder="Nieuw project (naam)">
    <button type="button" onclick="addProject()">Project toevoegen</button>
  </div>
  <div class="small">Projecten worden gebruikt als dropdown in de takenlijst en bij het aanmaken.</div>
  <ul id="projectList"></ul>

  <hr>

  <h3>Notificatie (later met backend)</h3>
  <div class="small">
    E-mail en tijdstip slaan we alvast op, maar automatische e-mail vereist een backend.
  </div>

  <label>E-mail adres</label>
  <input id="emailTo" placeholder="jij@domein.nl">

  <div class="row">
    <div>
      <label>Uur</label>
      <input id="notifyHour" type="number" min="0" max="23">
    </div>
    <div>
      <label>Minuut</label>
      <input id="notifyMinute" type="number" min="0" max="59">
    </div>
  </div>

  <button type="button" onclick="saveSettings()">Settings opslaan</button>

  <hr>

  <h3>Back-up</h3>
  <div class="row">
    <button type="button" onclick="exportJSON()">Export JSON</button>
    <input id="importFile" type="file" accept="application/json" onchange="importJSON(event)">
  </div>
  <div class="small">Export maakt een JSON-bestand. Import vervangt je huidige data in deze browser.</div>

  <hr>

  <button type="button" onclick="resetAll()">Alles wissen (reset)</button>
  <div class="small">Let op: dit verwijdert alle taken en settings in je browser.</div>
</section>

<script>
const KEY = "taskplanner_v7";

/** --------------------------
 *  Date helpers (robust local)
 *  -------------------------- **/
function pad2(n){ return String(n).padStart(2,"0"); }
function ymdFromDate(d){
  const x = new Date(d);
  return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
}
function dateFromYMD(ymd){
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(ymd||""));
  if (!m) return null;
  const y = Number(m[1]), mo = Number(m[2]), da = Number(m[3]);
  const dt = new Date(y, mo-1, da);
  if (dt.getFullYear()!==y || dt.getMonth()!==mo-1 || dt.getDate()!==da) return null;
  dt.setHours(0,0,0,0);
  return dt;
}
function startOfWeek(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  const day = (x.getDay() + 6) % 7; // monday=0
  x.setDate(x.getDate() - day);
  return x;
}
function parseWeek(value){
  if (!value) return startOfWeek(new Date());
  const dt = new Date(value);
  if (isNaN(dt.getTime())) return startOfWeek(new Date());
  return startOfWeek(dt);
}
function clampInt(v, fallback){
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}
function uid(){
  return (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + Date.now());
}

/** --- State --- **/
let state = load();

function defaultState(){
  return {
    tasks: [],
    week: startOfWeek(new Date()).toISOString(),
    projects: ["Algemeen"],
    settings: { emailTo:"", notifyHour:12, notifyMinute:0 }
  };
}

function migrateTask(t){
  if (!("project" in t)) t.project = state.projects[0] || "Algemeen";
  if (!("priority" in t)) t.priority = "Medium";
  if (!("status" in t)) t.status = "Todo";
  if (!("estimateHours" in t)) t.estimateHours = 1;
  if (!("deadline" in t)) t.deadline = "";
  if (!("tags" in t)) t.tags = "";
  if (!("notes" in t)) t.notes = "";
  if (!("planned" in t)) t.planned = "";
  if (!("created" in t)) t.created = Date.now();
  if (!("updated" in t)) t.updated = t.created;
  if (!Array.isArray(t.checklist)) t.checklist = [];
  for (const it of t.checklist) {
    if (!it.id) it.id = uid();
    if (typeof it.text !== "string") it.text = String(it.text ?? "");
    it.done = !!it.done;
  }
  if (t.status !== "Todo" && t.status !== "Planned" && t.status !== "Done" && t.status !== "Archived"){
    t.status = "Todo";
  }
  // remove legacy slot if present
  if ("slot" in t) delete t.slot;
  return t;
}

function load(){
  const raw = localStorage.getItem(KEY);
  if (!raw) {
    // try legacy keys for convenience
    const legacyKeys = ["taskplanner_v6","taskplanner_v5"];
    for (const k of legacyKeys){
      const legacy = localStorage.getItem(k);
      if (legacy){
        try{
          JSON.parse(legacy);
          localStorage.setItem(KEY, legacy);
          break;
        }catch{}
      }
    }
  }

  const raw2 = localStorage.getItem(KEY);
  if (!raw2) return defaultState();

  try {
    const s = JSON.parse(raw2);
    if (!Array.isArray(s.tasks)) s.tasks = [];
    if (!s.week) s.week = startOfWeek(new Date()).toISOString();
    if (!Array.isArray(s.projects) || s.projects.length === 0) s.projects = ["Algemeen"];
    if (!s.settings) s.settings = { emailTo:"", notifyHour:12, notifyMinute:0 };

    s.settings.notifyHour = clampInt(s.settings.notifyHour, 12);
    s.settings.notifyMinute = clampInt(s.settings.notifyMinute, 0);
    s.settings.emailTo = String(s.settings.emailTo ?? "");

    state = s; // for migrate defaults
    s.tasks = s.tasks.map(migrateTask);
    return s;
  } catch {
    return defaultState();
  }
}

function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function weekDate(){ return parseWeek(state.week); }
function setWeek(d){ state.week = startOfWeek(d).toISOString(); save(); }

/** --- Navigation --- **/
function show(id){
  document.querySelectorAll("section").forEach(s=>s.hidden=true);
  document.getElementById(id).hidden=false;

  if (id === "tasks") renderTasks();
  if (id === "week") renderWeek();
  if (id === "settings") renderSettings();
  if (id === "create") renderCreate();
}

/** --- Create form --- **/
function renderCreate(){
  const sel = document.getElementById("createProject");
  sel.innerHTML = state.projects.map(p => `<option>${escapeHtml(p)}</option>`).join("");
}

/** --- Task creation --- **/
function addTask(e){
  e.preventDefault();
  const t = {
    id: uid(),
    title: title.value.trim(),
    created: Date.now(),
    updated: Date.now(),
    project: createProject.value || (state.projects[0] || "Algemeen"),
    priority: createPriority.value || "Medium",
    status: "Todo",
    estimateHours: Number(createEstimate.value || 1),
    deadline: createDeadline.value || "",
    tags: "",
    notes: "",
    planned: "",
    checklist: []
  };
  state.tasks.push(t);
  save();

  title.value = "";
  createPriority.value = "Medium";
  createEstimate.value = 1;
  createDeadline.value = "";

  show("tasks");
}

/** --- Sorting --- **/
function sortTasks(list){
  return [...list].sort((a,b) => {
    const aArch = a.status === "Archived";
    const bArch = b.status === "Archived";
    if (aArch !== bArch) return aArch ? 1 : -1;

    const aPlanned = !!a.planned;
    const bPlanned = !!b.planned;
    if (aPlanned !== bPlanned) return aPlanned ? 1 : -1;

    if (!aPlanned && !bPlanned) return (b.created||0) - (a.created||0);

    const d = String(a.planned).localeCompare(String(b.planned));
    if (d !== 0) return d;

    return (b.created||0) - (a.created||0);
  });
}

/** --- Update fields --- **/
function updateTaskField(id, field, value){
  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;
  t[field] = value;
  t.updated = Date.now();
  save();
  rerenderVisible();
}

function rerenderVisible(){
  if (!document.getElementById("tasks").hidden) renderTasks();
  if (!document.getElementById("week").hidden) renderWeek();
}

/** --- Planning date (commit-on-blur) --- **/
function rememberDate(el){ el.dataset.prev = el.value || ""; }
function commitDate(el){
  const id = el.dataset.taskid;
  const prev = el.dataset.prev || "";
  const next = el.value || "";
  if (prev === next) return;

  const t = state.tasks.find(x => x.id === id);
  if (!t) return;

  t.planned = next;

  if (next) {
    if (t.status === "Todo") t.status = "Planned";
  } else {
    if (t.status === "Planned") t.status = "Todo";
  }

  t.updated = Date.now();
  save();

  // ordering changes possible
  rerenderVisible();
}

function planToday(id){
  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;
  t.planned = ymdFromDate(new Date());
  if (t.status === "Todo") t.status = "Planned";
  t.updated = Date.now();
  save();
  rerenderVisible();
}
function clearPlan(id){
  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;
  t.planned = "";
  if (t.status === "Planned") t.status = "Todo";
  t.updated = Date.now();
  save();
  rerenderVisible();
}

/** --- Delete / Archive / Done actions --- **/
function deleteTask(id){
  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;
  if (!confirm(`Taak verwijderen?\n\n${t.title}`)) return;
  state.tasks = state.tasks.filter(x=>x.id!==id);
  save();
  rerenderVisible();
}
function archiveTask(id){
  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;
  t.status = "Archived";
  t.updated = Date.now();
  save();
  rerenderVisible();
}
function markDone(id){
  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;
  t.status = "Done";
  t.updated = Date.now();
  save();
  rerenderVisible();
}

/** --- Checklist --- **/
function addChecklistItem(id){
  const input = document.getElementById("cl_new_" + id);
  if (!input) return;
  const txt = (input.value || "").trim();
  if (!txt) return;

  const t = state.tasks.find(x=>x.id===id);
  if (!t) return;

  t.checklist.push({ id: uid(), text: txt, done: false });
  t.updated = Date.now();
  save();

  input.value = "";
  rerenderVisible();
}
function toggleChecklistItem(taskId, itemId, checked){
  const t = state.tasks.find(x=>x.id===taskId);
  if (!t) return;
  const it = t.checklist.find(i=>i.id===itemId);
  if (!it) return;

  it.done = !!checked;
  t.updated = Date.now();
  save();
  rerenderVisible();
}
function deleteChecklistItem(taskId, itemId){
  const t = state.tasks.find(x=>x.id===taskId);
  if (!t) return;

  t.checklist = t.checklist.filter(i=>i.id!==itemId);
  t.updated = Date.now();
  save();
  rerenderVisible();
}
function checklistProgress(t){
  const total = (t.checklist || []).length;
  const done = (t.checklist || []).filter(i=>i.done).length;
  return { total, done };
}

/** --- Deadline badge --- **/
function deadlineBadge(t){
  if (!t.deadline) return "";
  const dl = dateFromYMD(t.deadline);
  if (!dl) return `<span class="badge warn">Deadline ${escapeHtml(t.deadline)}</span>`;

  const today = dateFromYMD(ymdFromDate(new Date()));
  const ms = dl.getTime() - today.getTime();
  const days = Math.round(ms / 86400000);

  if (t.status !== "Done" && t.status !== "Archived" && days < 0){
    return `<span class="badge danger">Overdue ${escapeHtml(t.deadline)}</span>`;
  }
  if (t.status !== "Done" && t.status !== "Archived" && days <= 3){
    return `<span class="badge warn">Binnenkort ${escapeHtml(t.deadline)}</span>`;
  }
  return `<span class="badge">Deadline ${escapeHtml(t.deadline)}</span>`;
}

/** --- Filters --- **/
function buildFilters(){
  const fProject = document.getElementById("fProject");
  const cur = fProject.value || "";
  const options = ['<option value="">Alle</option>']
    .concat(state.projects.map(p => `<option ${p===cur?'selected':''}>${escapeHtml(p)}</option>`));
  fProject.innerHTML = options.join("");
}

/** --- Render tasks --- **/
function renderTasks(){
  buildFilters();

  const rows = document.getElementById("taskRows");
  rows.innerHTML = "";

  const query = (document.getElementById("q")?.value || "").trim().toLowerCase();
  const fProj = document.getElementById("fProject")?.value || "";
  const fStat = document.getElementById("fStatus")?.value || "";
  const showDone = (document.getElementById("showDone")?.value || "yes") === "yes";

  let list = sortTasks(state.tasks);

  list = list.filter(t => {
    if (!showDone && t.status === "Done") return false;
    if (fProj && t.project !== fProj) return false;
    if (fStat){
      if (fStat === "Archived") return t.status === "Archived";
      return t.status === fStat;
    }
    if (query){
      const hay = `${t.title} ${t.tags||""} ${t.notes||""}`.toLowerCase();
      if (!hay.includes(query)) return false;
    }
    return true;
  });

  for (const t of list) {
    const tr = document.createElement("tr");
    if (!t.planned) tr.classList.add("unplanned");
    if (t.status === "Done") tr.classList.add("done-row");

    const prog = checklistProgress(t);
    const progText = prog.total ? `${prog.done}/${prog.total}` : `0/0`;

    tr.innerHTML = `
      <td>
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div style="flex:1;">
            <div><strong>${escapeHtml(t.title)}</strong></div>

            <div class="small" style="margin-top:4px;">
              ${t.project ? `<span class="badge">${escapeHtml(t.project)}</span>` : ""}
              <span class="badge">${escapeHtml(t.priority)}</span>
              <span class="badge">${escapeHtml(t.status)}</span>
              <span class="badge">Checklist ${progText}</span>
              ${deadlineBadge(t)}
            </div>

            <div class="small" style="margin-top:4px;">Aangemaakt: ${new Date(t.created).toLocaleString()}</div>

            ${t.planned
              ? `<div class="small">Gepland: ${escapeHtml(t.planned)}</div>`
              : `<div class="small">Niet ingepland</div>`
            }

            ${t.tags ? `<div class="small">Tags: ${escapeHtml(t.tags)}</div>` : ``}

            ${t.notes ? `<div class="note"><strong class="small">Opmerkingen</strong>\n${escapeHtml(t.notes)}</div>` : ``}
          </div>

          <div style="min-width:140px;">
            <button type="button" class="mini-btn" onclick="markDone('${t.id}')">Voltooi</button>
            <button type="button" class="mini-btn" onclick="archiveTask('${t.id}')">Archiveer</button>
            <button type="button" class="mini-btn" onclick="deleteTask('${t.id}')">Verwijder</button>
          </div>
        </div>

        <div class="cl-wrap" style="margin-top:10px;">
          <div class="cl-head">
            <strong>Mini-checklist</strong>
            <span class="small">${progText}</span>
          </div>

          <div class="mini-row" style="margin-top:6px;">
            <input id="cl_new_${t.id}" placeholder="Checklist item toevoegen">
            <button class="mini-btn" type="button" onclick="addChecklistItem('${t.id}')">+</button>
          </div>

          <ul class="cl-list">
            ${(t.checklist||[]).map(it => `
              <li class="cl-item">
                <input type="checkbox"
                       ${it.done ? "checked" : ""}
                       onchange="toggleChecklistItem('${t.id}','${it.id}', this.checked)">
                <span class="txt ${it.done ? "done" : ""}">${escapeHtml(it.text)}</span>
                <button class="mini-btn" type="button" onclick="deleteChecklistItem('${t.id}','${it.id}')">x</button>
              </li>
            `).join("")}
          </ul>
          ${(t.checklist||[]).length === 0 ? `<div class="small muted">Nog geen checklist items.</div>` : ``}
        </div>
      </td>

      <td>
        <label>Project</label>
        <select onchange="updateTaskField('${t.id}','project',this.value)">
          ${state.projects.map(p => `<option ${p===t.project?'selected':''}>${escapeHtml(p)}</option>`).join("")}
        </select>

        <label>Prioriteit</label>
        <select onchange="updateTaskField('${t.id}','priority',this.value)">
          ${opt("High", t.priority)}${opt("Medium", t.priority)}${opt("Low", t.priority)}
        </select>

        <label>Status</label>
        <select onchange="updateTaskField('${t.id}','status',this.value)">
          ${opt("Todo", t.status)}${opt("Planned", t.status)}${opt("Done", t.status)}${opt("Archived", t.status)}
        </select>

        <label>Schatting (uren)</label>
        <input type="number" min="0" step="0.5"
               value="${Number(t.estimateHours||0)}"
               onchange="updateTaskField('${t.id}','estimateHours', this.value==='' ? '' : Number(this.value))">

        <label>Deadline</label>
        <input type="date"
               value="${escapeAttr(t.deadline||"")}"
               onchange="updateTaskField('${t.id}','deadline', this.value)">

        <label>Tags</label>
        <input value="${escapeAttr(t.tags||"")}"
               onchange="updateTaskField('${t.id}','tags', this.value)">

        <label>Opmerkingen</label>
        <textarea rows="3"
                  onchange="updateTaskField('${t.id}','notes', this.value)">${escapeHtml(t.notes||"")}</textarea>

        <label>Plannen op datum</label>
        <input type="date"
               value="${escapeAttr(t.planned||"")}"
               data-taskid="${t.id}"
               onfocus="rememberDate(this)"
               onblur="commitDate(this)">

        <div class="row">
          <button type="button" onclick="planToday('${t.id}')">Plan vandaag</button>
          <button type="button" onclick="clearPlan('${t.id}')">Planning wissen</button>
        </div>
      </td>
    `;
    rows.appendChild(tr);
  }
}

/** --- Week view (interactive checklist + complete/archive buttons) --- **/
function changeWeek(n){
  const w = weekDate();
  w.setDate(w.getDate() + 7*n);
  setWeek(w);
  renderWeek();
}
function goThisWeek(){
  setWeek(new Date());
  renderWeek();
}

function renderWeek(){
  const w = weekDate();
  weekTitle.textContent = "Week vanaf " + w.toLocaleDateString();
  weekGrid.innerHTML = "";

  for (let i=0; i<7; i++){
    const d = new Date(w);
    d.setDate(d.getDate() + i);
    const dIso = ymdFromDate(d);

    const dayTasks = state.tasks
      .filter(t => t.planned === dIso && t.status !== "Archived")
      .sort((a,b) => ((b.created||0)-(a.created||0)));

    const dayDiv = document.createElement("div");
    dayDiv.className = "week-day";

    dayDiv.innerHTML = `
      <div class="week-day-head">
        <div>
          <strong>${escapeHtml(dIso)}</strong>
          <div class="small">${d.toLocaleDateString(undefined, { weekday: 'long' })}</div>
        </div>
        <div class="small">${dayTasks.length} taak/taken</div>
      </div>
      <div class="week-day-body" id="day_${escapeAttr(dIso)}"></div>
    `;

    weekGrid.appendChild(dayDiv);

    const body = dayDiv.querySelector("#day_" + CSS.escape(dIso));
    if (!body) continue;

    if (dayTasks.length === 0){
      const empty = document.createElement("div");
      empty.className = "week-empty small muted";
      empty.textContent = "Geen taken gepland.";
      body.appendChild(empty);
      continue;
    }

    for (const t of dayTasks) {
      const prog = checklistProgress(t);
      const progText = prog.total ? `${prog.done}/${prog.total}` : `0/0`;

      const card = document.createElement("div");
      card.className = `week-task pri-${t.priority || "Medium"}`;

      card.innerHTML = `
        <div class="week-task-title">${escapeHtml(t.title)}</div>

        <div class="week-task-meta">
          ${t.project ? `<span class="pill">${escapeHtml(t.project)}</span>` : ``}
          <span class="pill">${escapeHtml(t.priority)}</span>
          <span class="pill">${escapeHtml(t.status)}</span>
          <span class="pill">CL ${progText}</span>
          ${t.deadline ? `<span class="pill">${stripTags(deadlineBadge(t))}</span>` : ``}
        </div>

        ${t.tags ? `<div class="small" style="margin-top:6px;">Tags: ${escapeHtml(t.tags)}</div>` : ``}

        ${t.notes ? `<div class="note"><strong class="small">Opmerkingen</strong>\n${escapeHtml(t.notes)}</div>` : ``}

        ${(t.checklist||[]).length === 0 ? `` : `
          <div class="week-cl">
            <ul>
              ${(t.checklist||[]).map(it => `
                <li>
                  <input type="checkbox"
                         ${it.done ? "checked" : ""}
                         onchange="toggleChecklistItem('${t.id}','${it.id}', this.checked)">
                  <span class="txt ${it.done ? "done" : ""}">${escapeHtml(it.text)}</span>
                </li>
              `).join("")}
            </ul>
          </div>
        `}

        <div class="week-actions">
          <button type="button" onclick="markDone('${t.id}')">Voltooi</button>
          <button type="button" onclick="archiveTask('${t.id}')">Archiveer</button>
          <button type="button" onclick="clearPlan('${t.id}')">Uit dag halen</button>
        </div>
      `;

      body.appendChild(card);
    }
  }
}

/** --- Settings --- **/
function renderSettings(){
  const ul = document.getElementById("projectList");
  ul.innerHTML = "";

  state.projects.forEach((p, idx) => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${escapeHtml(p)}
      ${idx===0 ? ` <span class="small">(default)</span>` :
        ` <button type="button" onclick="removeProject('${escapeAttr(p)}')">verwijderen</button>`}
    `;
    ul.appendChild(li);
  });

  emailTo.value = state.settings.emailTo || "";
  notifyHour.value = state.settings.notifyHour ?? 12;
  notifyMinute.value = state.settings.notifyMinute ?? 0;

  renderCreate();
}

function addProject(){
  const name = (newProject.value || "").trim();
  if (!name) return;
  if (state.projects.includes(name)) { alert("Project bestaat al."); return; }

  state.projects.push(name);
  save();
  newProject.value = "";
  renderSettings();
  rerenderVisible();
}

function removeProject(name){
  const used = state.tasks.some(t => t.project === name);
  if (used) { alert("Project wordt nog gebruikt in taken. Pas eerst die taken aan."); return; }

  state.projects = state.projects.filter(p => p !== name);
  if (state.projects.length === 0) state.projects = ["Algemeen"];
  save();
  renderSettings();
  rerenderVisible();
}

function saveSettings(){
  state.settings.emailTo = (emailTo.value || "").trim();
  state.settings.notifyHour = clampInt(notifyHour.value, 12);
  state.settings.notifyMinute = clampInt(notifyMinute.value, 0);
  save();
  alert("Settings opgeslagen.");
}

/** --- Export / Import --- **/
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "taakplanner-export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importJSON(e){
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = () => {
    try{
      const s = JSON.parse(String(r.result||""));
      if (!s || typeof s !== "object") throw new Error("invalid");
      if (!Array.isArray(s.tasks) || !Array.isArray(s.projects) || !s.settings) throw new Error("shape");

      state = s;
      if (!state.week) state.week = startOfWeek(new Date()).toISOString();
      if (!state.projects.length) state.projects = ["Algemeen"];
      state.settings.notifyHour = clampInt(state.settings.notifyHour, 12);
      state.settings.notifyMinute = clampInt(state.settings.notifyMinute, 0);
      state.settings.emailTo = String(state.settings.emailTo ?? "");
      state.tasks = state.tasks.map(migrateTask);

      save();
      alert("Import gelukt.");
      renderSettings();
      show("tasks");
    }catch{
      alert("Import mislukt: JSON is niet geldig voor deze app.");
    }finally{
      e.target.value = "";
    }
  };
  r.readAsText(file);
}

function resetAll(){
  if (!confirm("Weet je zeker dat je alles wilt wissen?")) return;
  localStorage.removeItem(KEY);
  state = defaultState();
  save();
  show("create");
}

/** --- utils --- **/
function opt(v, cur){ return `<option ${v===cur?'selected':''}>${v}</option>`; }
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }
function stripTags(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  return escapeHtml(tmp.textContent || "");
}

/** --- boot --- **/
show("create");
renderCreate();
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

  // Firebase-config (die jij al had)
  const firebaseConfig = {
    apiKey: "AIzaSyDexeK2_ZkUOHfa8jV5nDEoDQgXoE7fV3c",
    authDomain: "taakplanner-b0236.firebaseapp.com",
    projectId: "taakplanner-b0236",
    storageBucket: "taakplanner-b0236.firebasestorage.app",
    messagingSenderId: "131823414976",
    appId: "1:131823414976:web:78b6037693d247e9680725"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  console.log("Firebase geladen");
</script>
</body>
</html>
